<?xml version="1.0" encoding="UTF-8"?>
<sequence name="ResourceSynProfileMatrixSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <!-- CREAR TEMPLATE PROFILE MATRICES -->
    <log level="custom" category="DEBUG">
        <property name="ResourceSynProfileMatrixSeq" value="Inicio..." />
        <property name="uri.var.applicationGroupId" expression="get-property('uri.var.applicationGroupId')" />
    </log>
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/MatrixSimple?applicationGroupId={uri.var.applicationGroupId}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <log level="custom" category="DEBUG">
                <property name="ResourceSynProfileMatrixSeq.1" expression="boolean(//matrixSimpleList/matrixSimple)" />
            </log>
            <filter regex="true" source="boolean(//matrixSimpleList/matrixSimple)">
                <then>
                    <iterate expression="//matrixSimple" id="matrixSimpleListId">
                        <target>
                            <sequence>
                                <property name="uri.var.matrixId" expression="//id" scope="default" type="STRING" />
                                <log level="custom" category="DEBUG">
                                    <property name="ResourceSynProfileMatrixSeq" value="Inicio.30." />
                                    <property name="uri.var.transactionalProfileId" expression="get-property('uri.var.transactionalProfileId')" scope="default" type="STRING" />
                                    <property name="uri.var.applicationGroupId" expression="get-property('uri.var.applicationGroupId')" scope="default" type="STRING" />
                                    <property name="uri.var.matrixId" expression="get-property('uri.var.matrixId')" scope="default" type="STRING" />
                                </log>
                                <call>
                                    <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/TemplateProfileMatrixSimple?transactionalProfileId={uri.var.transactionalProfileId}&amp;fieldId={uri.var.matrixId}" />
                                </call>
                                <property name="uri.var.templateProfileMatrixId" expression="(//templateProfileMatrix/id)[1]" scope="default" type="STRING" />
                                <log level="custom" category="DEBUG">
                                    <property name="ResourceSynProfileMatrixSeq" value="Inicio.31." />
                                    <property name="uri.var.transactionalProfileId" expression="get-property('uri.var.transactionalProfileId')" scope="default" type="STRING" />
                                    <property name="uri.var.applicationGroupId" expression="get-property('uri.var.applicationGroupId')" scope="default" type="STRING" />
                                    <property name="uri.var.fieldId" expression="get-property('uri.var.fieldId')" scope="default" type="STRING" />
                                    <property name="uri.var.templateProfileMatrixId" expression="get-property('uri.var.templateProfileMatrixId')" scope="default" type="STRING" />
                                </log>
                                <filter regex="false" source="boolean(get-property('uri.var.templateProfileMatrixId'))">
                                    <then>
                                        <payloadFactory media-type="json">
                                            <format>
                                                {
                                                    "templateProfileMatrix": {
                                                        "matrix": {
                                                            "id": $1
                                                        },
                                                        "transactionalProfile": {
                                                            "id": $2
                                                        }
                                                    }
                                                }
                                            </format>
                                            <args>
                                                <arg evaluator="xml" expression="get-property('uri.var.matrixId')" />
                                                <arg evaluator="xml" expression="get-property('uri.var.transactionalProfileId')" />
                                            </args>
                                        </payloadFactory>
                                        <call>
                                            <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/TemplateProfileMatrix" />
                                        </call>
                                        <property name="uri.var.templateProfileMatrixId" expression="//id" />
                                        <sequence key="ResourceSynProfileMatrixDetailSeq" />
                                        <!--sequence key="ResourceSynProfileMatrixDetailSeq" /-->
                                        <!--sequence key="ResourceSynProfileMatrixDetailSeq" /-->
                                    </then>
                                </filter>
                            </sequence>
                        </target>
                    </iterate>
                    <aggregate id="matrixSimpleListId">
                        <completeCondition>
                            <messageCount min="-1" max="-1" />
                        </completeCondition>
                        <onComplete expression="$body/*[1]">
                            <log level="custom" category="DEBUG">
                                <property name="agregado" value="ok" />
                            </log>
                        </onComplete>
                    </aggregate>
                </then>
            </filter>
        </then>
        <else>
            <property name="fault" value="error when consulting fields by id " />
            <sequence key="FaultSeq" />
        </else>
    </filter>
</sequence>