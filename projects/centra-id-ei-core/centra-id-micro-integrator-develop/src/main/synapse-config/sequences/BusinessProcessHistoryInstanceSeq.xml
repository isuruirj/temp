<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessProcessHistoryInstanceSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="BusinessProcessHistoryInstanceSeq" value="Inicio..." />
    </log>
    <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="BPS_SERVER_USER_DATO" expression="synapse:get-property('BPS_SERVER_USER')" scope="default" />
    <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="BPS_SERVER_PASSWORD_DATO" expression="synapse:get-property('BPS_SERVER_PASSWORD')" scope="default" />
    <property xmlns:ns="http://org.apache.synapse/xsd" name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:BPS_SERVER_USER_DATO,':',$ctx:BPS_SERVER_PASSWORD_DATO)))" scope="transport" />
    <property name="uri.var.url" expression="fn:concat(get-property('uri.var.bussinesProcessServiceHost'),'/bpmn/history/historic-task-instances?processInstanceId=',get-property('uri.var.instanceId'),'&amp;order=desc')" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.url}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="jsonResultStart" expression="json-eval($.start)" scope="default" type="INTEGER" />
            <property name="jsonResultTotal" expression="json-eval($.total)" scope="default" type="INTEGER" />
            <property name="jsonResultOrder" expression="json-eval($.order)" scope="default" type="STRING" />
            <property name="jsonResultSort" expression="json-eval($.sort)" scope="default" type="STRING" />
            <property name="jsonResultSize" expression="json-eval($.size)" scope="default" type="INTEGER" />
            <filter regex="^[1-9][0-9]*$" source="get-property('jsonResultTotal')">
                <then>
                    <iterate expression="//data" sequential="true">
                        <target>
                            <sequence>
                                <property name="uri.var.taskId" expression="//data/id/text()" />
                                <property name="deleteReason" expression="//data/deleteReason/text()" />
                                <property name="durationInMillis" expression="//data/durationInMillis/text()" />
                                <property name="processDefinitionId" expression="//data/processDefinitionId/text()" />
                                <property name="assignee" expression="//data/assignee/text()" />
                                <property name="dueDate" expression="//data/dueDate/text()" />
                                <property name="startTime" expression="//data/startTime/text()" />
                                <property name="endTime" expression="//data/endTime/text()" />
                                <property name="name" expression="//data/name/text()" />
                                <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="BPS_SERVER_USER_DATO" expression="synapse:get-property('BPS_SERVER_USER')" scope="default" />
                                <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="BPS_SERVER_PASSWORD_DATO" expression="synapse:get-property('BPS_SERVER_PASSWORD')" scope="default" />
                                <property xmlns:ns="http://org.apache.synapse/xsd" name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:BPS_SERVER_USER_DATO,':',$ctx:BPS_SERVER_PASSWORD_DATO)))" scope="transport" />
                                <call>
                                    <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.bussinesProcessServiceHost}/bpmn/runtime/tasks/{uri.var.taskId}/comments" />
                                </call>
                                <property name="comment" expression="//message/text()" />
                                <payloadFactory media-type="xml">
                                    <format>
                                        <tasks>
                                            <id>$1</id>
                                            <deleteReason>$2</deleteReason>
                                            <durationInMillis>$3</durationInMillis>
                                            <processDefinitionId>$4</processDefinitionId>
                                            <assignee>$5</assignee>
                                            <dueDate>$6</dueDate>
                                            <startTime>$7</startTime>
                                            <endTime>$8</endTime>
                                            <name>$9</name>
                                            <comment>$10</comment>
                                        </tasks>
                                    </format>
                                    <args>
                                        <arg evaluator="xml" expression="get-property('uri.var.taskId')" />
                                        <arg evaluator="xml" expression="get-property('deleteReason')" />
                                        <arg evaluator="xml" expression="get-property('durationInMillis')" />
                                        <arg evaluator="xml" expression="get-property('processDefinitionId')" />
                                        <arg evaluator="xml" expression="get-property('assignee')" />
                                        <arg evaluator="xml" expression="get-property('dueDate')" />
                                        <arg evaluator="xml" expression="get-property('startTime')" />
                                        <arg evaluator="xml" expression="get-property('endTime')" />
                                        <arg evaluator="xml" expression="get-property('name')" />
                                        <arg evaluator="xml" expression="get-property('comment')" />
                                    </args>
                                </payloadFactory>
                            </sequence>
                        </target>
                    </iterate>
                    <property name="data" scope="default">
                        <data />
                    </property>
                    <aggregate>
                        <completeCondition>
                            <messageCount min="-1" max="-1" />
                        </completeCondition>
                        <onComplete expression="$body/*[1]" enclosingElementProperty="data">
                            <log level="custom" category="DEBUG">
                                <property name="agregado" value="ok" />
                            </log>
                        </onComplete>
                    </aggregate>
                </then>
                <else>
                    <payloadFactory media-type="xml">
                        <format>
                            <tasks />
                        </format>
                        <args />
                    </payloadFactory>
                </else>
            </filter>
            <property name="messageType" scope="axis2" type="STRING" value="application/json" />
            <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
        </then>
        <else>
            <property name="fault" value="error when consulting history tasks " />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <xslt key="gov:/centra-id/xslt/sort.xsl">
        <property name="container" value="//*:data" />
        <property name="subcontainer" value="*:tasks" />
        <property name="element" value="*:id" />
        <property name="order" value="descending" />
        <property name="data-type" value="number" />
    </xslt>
    <log level="full" category="INFO">
        <property name="BusinessProcessHistoryInstanceSeq" value="Fin..." />
    </log>
</sequence>