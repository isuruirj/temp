<?xml version="1.0" encoding="UTF-8"?>
<sequence name="MassiveProcessUsersIdentityCreateSeq" onError="FaultMassiveProcessUsersSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:cen="centra-id.com">
    <log level="custom" separator=" | ">
        <property name="MassiveProcessUsersIdentityCreateSeq" value="Inicio..." />
    </log>
    <!--Salvar los datos del empleado a crear -->
    <enrich>
        <source type="body" />
        <target type="property" property="payload" />
    </enrich>
    <property expression="$body//*" name="employeeData" scope="default" type="OM" />
    <log level="custom" separator="| ">
        <property name="MassiveProcessUsersIdentityCreateSeq" expression="get-property('employeeData')//cen:codigoTrabajador" />
    </log>
    <!-- Recuperar referencias-->
    <property name="uri.var.companyCode" expression="get-property('employeeData')//cen:codigoCompania/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/company/Company?code={uri.var.companyCode}" />
    </call>
    <property name="companyId" expression="//company/id" />
    <property name="mail" expression="fn:concat(get-property('username'),'@',//company/domainName)" />
    <!-- -->
    <property name="uri.var.divisionCode" expression="get-property('employeeData')//cen:codigoDivision/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog?code={uri.var.divisionCode}&amp;catalogType.code=DIV" />
    </call>
    <property name="divisionId" expression="//catalog/id" />
    <!-- -->
    <property name="uri.var.areaCode" expression="get-property('employeeData')//cen:codigoArea/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog?code={uri.var.areaCode}&amp;catalogType.code=ARE" />
    </call>
    <property name="areaId" expression="//catalog/id" />
    <!-- -->
    <property name="uri.var.departmentCode" expression="get-property('employeeData')//cen:codigoDepartamento/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog?code={uri.var.departmentCode}&amp;catalogType.code=DEP" />
    </call>
    <property name="departmentId" expression="//catalog/id" />
    <!-- -->
    <property name="uri.var.positionName" expression="get-property('employeeData')//cen:nombreCargo/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog?name={uri.var.positionName}&amp;catalogType.code=CAR" />
    </call>
    <property name="positionId" expression="//catalog/id" />
    <!-- -->
    <property name="uri.var.tipoIdentificacionCode" expression="get-property('employeeData')//cen:tipoIdentificacion/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog?code={uri.var.tipoIdentificacionCode}&amp;catalogType.code=TIPIDE" />
    </call>
    <property name="identificationTypeId" expression="//catalog/id" />
    <!-- -->
    <property name="uri.var.costCenterCode" expression="get-property('employeeData')//cen:codigoCentroCosto/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/company/CostCenter?code={uri.var.costCenterCode}&amp;company.code={uri.var.companyCode}" />
    </call>
    <property name="costCenterId" expression="//costCenter/id" />
    <!-- -->
    <property name="uri.var.typeUserCode" expression="get-property('employeeData')//cen:tipoUsuario/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/TypeUser?code={uri.var.typeUserCode}&amp;type=T" />
    </call>
    <property name="typeUserId" expression="//typeUser/id" />
    <!-- -->
    <property name="uri.var.subtypeUserCode" expression="get-property('employeeData')//cen:subTipo/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/TypeUser?code={uri.var.subtypeUserCode}&amp;type=S" />
    </call>
    <property name="subtypeUserId" expression="//typeUser/id" />
    <!-- -->
    <filter regex="true" source="boolean(get-property('employeeData')//cen:identificacionSupervisor/text())">
        <then>
            <property name="uri.var.identificacionSupervisor" expression="get-property('employeeData')//cen:identificacionSupervisor/text()" />
            <call>
                <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSimple/0/1?identification={uri.var.identificacionSupervisor}" />
            </call>
            <property name="userDataSupervisorId" expression="//userData/id" />
        </then>
    </filter>
    <sequence key="GetCurrentDateTemplate" />
    <enrich description="Restore original payload">
        <source clone="false" property="payload" type="property" />
        <target type="body" />
    </enrich>
    <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
    <property name="Accept" scope="transport" type="STRING" value="application/xml" />
    <xslt key="gov:/centra-id/xslt/massiveProcessToJson.xsl">
        <property name="currentDate" expression="get-property('currentDate')" />
        <property name="companyId" expression="get-property('companyId')" />
        <property name="divisionId" expression="get-property('divisionId')" />
        <property name="areaId" expression="get-property('areaId')" />
        <property name="departmentId" expression="get-property('departmentId')" />
        <property name="positionId" expression="get-property('positionId')" />
        <property name="costCenterId" expression="get-property('costCenterId')" />
        <property name="typeUserId" expression="get-property('typeUserId')" />
        <property name="subtypeUserId" expression="get-property('subtypeUserId')" />
        <property name="identificationTypeId" expression="get-property('identificationTypeId')" />
        <property name="mail" expression="get-property('mail')" />
        <property name="globalProfileId" expression="get-property('employeeData')//cen:globalProfileId/text()" />
        <property name="userDataSupervisorId" expression="get-property('userDataSupervisorId')" />
    </xslt>
    <property expression="$body/*[1]" name="payload" scope="default" type="STRING" />
    <script language="js">
        <![CDATA[var payload = mc.getProperty("payload");mc.setPayloadJSON(payload);]]>
    </script>
    <property name="messageType" scope="axis2" type="STRING" value="application/json" />
    <call>
        <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserData" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="username" expression="//username" />
            <payloadFactory media-type="xml">
                <format>
                    <p:_postupdateusername xmlns:p="centra-id.com">
                        <p:username>$1</p:username>
                        <p:id>$2</p:id>
                    </p:_postupdateusername>
                </format>
                <args>
                    <arg evaluator="xml" expression="get-property('username')" />
                    <arg evaluator="xml" expression="get-property('employeeData')//cen:id/text()" />
                </args>
            </payloadFactory>
            <call>
                <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.dataServiceHost}/MassiveProcessDSS.HTTPEndpoint/updateUsername" />
            </call>
        </then>
        <else>
            <property name="fault" value="Fail created userData" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="MassiveProcessUsersIdentityCreateSeq" value="Fin..." />
    </log>
</sequence>