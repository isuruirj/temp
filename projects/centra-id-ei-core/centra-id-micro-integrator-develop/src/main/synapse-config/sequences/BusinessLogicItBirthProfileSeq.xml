<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessLogicItBirthProfileSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="BusinessLogicItBirthProfileSeq" value="Inicio..." />
        <property name="globalProfileId" expression="//globalProfileId" />
    </log>
    <property name="globalProfileId" expression="//globalProfileId" />
    <filter regex="true" source="boolean($ctx:globalProfileId)">
        <then>
            <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
            <property name="Accept" scope="transport" type="STRING" value="application/xml" />
            <payloadFactory media-type="xml">
                <format>
                    <ci:update_all_query_operation xmlns:ci="centra-id.com">
                        <ci:table>SCH_CENTRA_ID.GLOBAL_PROFILES</ci:table>
                        <ci:set>IS_BIRTH=0</ci:set>
                        <ci:where>VALID=1</ci:where>
                    </ci:update_all_query_operation>
                </format>
                <args />
            </payloadFactory>
            <call>
                <endpoint template="HTTPEndpointPutTemplate" uri="{uri.var.dataServiceHost}/UsersDSS.HTTPEndpoint/updateAll" />
            </call>
            <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
            <property name="Accept" scope="transport" type="STRING" value="application/xml" />
            <payloadFactory media-type="xml">
                <format>
                    <ci:update_all_query_operation xmlns:ci="centra-id.com">
                        <ci:table>SCH_CENTRA_ID.GLOBAL_PROFILES</ci:table>
                        <ci:set>IS_BIRTH=1</ci:set>
                        <ci:where>VALID=1 AND ID=$1</ci:where>
                    </ci:update_all_query_operation>
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:globalProfileId" />
                </args>
            </payloadFactory>
            <call>
                <endpoint template="HTTPEndpointPutTemplate" uri="{uri.var.dataServiceHost}/UsersDSS.HTTPEndpoint/updateAll" />
            </call>
            <payloadFactory media-type="json">
                <format>
                    {
                        "result":  {
                            "code" : 0,
                            "message" : "Operation performed successfully"
                        }
                    }
                </format>
                <args />
            </payloadFactory>
            <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
        </then>
        <else>
            <property name="fault" value="globalProfileId attribute is missing" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="BusinessLogicItBirthProfileSeq" value="Fin..." />
    </log>
</sequence>