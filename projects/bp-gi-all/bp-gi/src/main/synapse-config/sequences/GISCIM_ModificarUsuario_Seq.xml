<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GISCIM_ModificarUsuario_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <enrich description="Store original payload">
        <source clone="true" type="body"/>
        <target property="original_payload" type="property"/>
    </enrich>
    <sequence key="GISCIM_ConsultarUsuario_Seq"/>
    <log description="userid" level="custom">
        <property name="seq" value="-------------------- GISCIM_ModificarUsuario_Seq --------------------"/>
        <property expression="get-property('userid')" name="userid"/>
    </log>
    <filter regex="true" source="boolean(get-property('userid'))">
        <then>
            <enrich description="Restore payload">
                <source clone="true" property="original_payload" type="property"/>
                <target type="body"/>
            </enrich>
            <log description="Replaced Body" level="custom">
                <property expression="$body/*" name="replaced_body"/>
            </log>
            <switch source="get-property('aplicacion')">
                <case regex=".*ad.*">
                    <sequence key="GISCIM_Mapping_AD_ModificarUsuario_Seq"/>
                    <property description="HTTP_METHOD:PATCH" name="HTTP_METHOD" scope="axis2" type="STRING" value="PATCH"/>
                </case>
                <case regex=".*bancs.*">
                    <sequence key="GISCIM_Mapping_BANCS_Seq"/>
                    <sequence key="GIRemove_Password_Seq"/>
                    <property description="HTTP_METHOD:PUT" name="HTTP_METHOD" scope="axis2" type="STRING" value="PUT"/>
                </case>
                <case regex=".*logiciel.*">
                    <sequence key="GISCIM_Mapping_LOGICIEL_Seq"/>
                    <property description="HTTP_METHOD:PUT" name="HTTP_METHOD" scope="axis2" type="STRING" value="PUT"/>
                </case>
                <case regex=".*pprd.*">
                    <sequence key="GISCIM_Mapping_PPRD_Seq"/>
                    <sequence key="GIRemove_Password_Seq"/>
                    <property description="HTTP_METHOD:PUT" name="HTTP_METHOD" scope="axis2" type="STRING" value="PUT"/>
                </case>
                <case regex=".*rhds.*">
                    <sequence key="GISCIM_Mapping_RHDS_ModificarUsuario_Seq"/>
                    <property description="HTTP_METHOD:PATCH" name="HTTP_METHOD" scope="axis2" type="STRING" value="PATCH"/>
                </case>
                <default/>
            </switch>
            <log description="SCIM Payload" level="custom">
                <property expression="json-eval($.)" name="SCIMPayload"/>
            </log>
            <property description="uri.var.resourcepath" expression="get-property('userid')" name="uri.var.resourcepath" scope="default" type="STRING"/>
            <sequence key="GISCIM_Seq"/>
            <filter regex="0" source="get-property('cgi-error-codigo')">
                <then>
                    <switch source="get-property('aplicacion')">
                        <case regex=".*ad.*">
                            <script description="Extract Roles" language="nashornJs"><![CDATA[var log = mc.getServiceLog();
                            var payload = JSON.parse(mc.getProperty('scimResponse'));
       						var roles = payload.groups;
        					var deletedRoles="";
							if (roles && roles.length > 0){
								for (var i = 0; i < roles.length; i++){
									deletedRoles=deletedRoles+roles[i].display;
									if((i+1)!=roles.length){
										deletedRoles=deletedRoles+",";
									}
							}
							log.info(deletedRoles);
							mc.setProperty("deletedRoles",deletedRoles);}]]></script>
                            <sequence key="GISCIM_AD_Assign_Role_Seq"/>
                        </case>
                        <case regex=".*rhds.*">
                            <property description="JSONPayload" expression="json-eval($)" name="JSONPayload" scope="default" type="STRING"/>
                            <script description="Extract Roles" language="nashornJs"><![CDATA[var payload = JSON.parse(mc.getProperty('JSONPayload'));
        				var roles = payload.groups;

        				if (roles && roles.length > 0) {
            				var rolesToRemove = '<parent xmlns:ser="http://service.ws.um.carbon.wso2.org">';

            				for (var i = 0; i < roles.length; i++) {
                				if (roles[i].display.toUpperCase().indexOf('RHDS') != -1) {
                    				rolesToRemove += '<ser:deletedRoles>' + roles[i].display + '</ser:deletedRoles>';
                					}
            				}
            				if (rolesToRemove.length > 0) {
                				rolesToRemove +="<ser:deletedRoles/></parent>";
                				mc.setProperty("rolesToRemove", rolesToRemove);
            					}
            				}]]></script>
                            <sequence key="GISCIM_RHDS_Assign_Role_Seq"/>
                        </case>
                        <default>
                            <log description="Log" level="custom">
                                <property name="msg" value="Role update is not necessary."/>
                            </log>
                        </default>
                    </switch>
                </then>
                <else>
                    <log description="Log" level="custom">
                        <property name="msg" value="Error in provisioning. Role update will not be processed for AD &amp; RHDS"/>
                    </log>
                </else>
            </filter>
        </then>
        <else>
            <property description="HTTP_SC:400" name="HTTP_SC" scope="axis2" type="STRING" value="400"/>
        </else>
    </filter>
</sequence>
