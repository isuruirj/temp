<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GIConsulta_Genera_Ticket_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIConsulta_Genera_Ticket_Seq -------------------- "/>
        <property expression="get-property('cgi-error-codigo')" name="cgi-error-codigo"/>
        <property expression="get-property('cgi-error-mensaje')" name="cgi-error-mensaje"/>
        <property expression="get-property('scimResponse')" name="scimResponse"/>
        <property expression="get-property('ERROR_CODE')" name="ERROR_CODE"/>
        <property expression="get-property('ERROR_MESSAGE')" name="ERROR_MESSAGE"/>
    </log>
    <property description="uri.var.host" expression="fn:concat(get-property('ENTERPRISE_INTEGRATOR_HOST'), '/api.centraid/application/ApplicationGroup?code=',get-property('aplicacion'))" name="uri.var.host" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
    <property description="HTTP_METHOD:GET" name="HTTP_METHOD" scope="axis2" type="STRING" value="GET"/>
    <log description="URL" level="custom">
        <property expression="get-property('uri.var.host')" name="URL"/>
    </log>
    <call>
        <endpoint key="GITareas_EP"/>
    </call>
    <property name="errorsNotRequireCodes" expression="json-eval($.applicationGroupList.applicationGroup[0].errorsNotRequireTicket)"></property>
    <log level="simple">
        <property name="errorsNotRequireCodes" expression="$ctx:errorsNotRequireCodes" />
        <property name="cgi-error-codigo" expression="$ctx:cgi-error-codigo" />
    </log>
    <filter xpath="string-length($ctx:cgi-error-codigo)>0 and string-length($ctx:errorsNotRequireCodes)>0 and fn:contains(concat(',',$ctx:errorsNotRequireCodes,','), concat(',',$ctx:cgi-error-codigo,','))" regex="true" >
        <then>
            <property name="requireticket" value="false" />
        </then>
        <else>
            <property name="requireticket" value="true" />
        </else>
    </filter>
    <!--<script description="Check Cod" language="js"><![CDATA[var payload=mc.getPayloadJSON();
            var errorsNotRequireTicket=payload.applicationGroupList.applicationGroup[0].errorsNotRequireTicket;
            if(errorsNotRequireTicket){
            	var arr=errorsNotRequireTicket.split(',');
            	mc.setProperty('requireticket',checkRequireTicket(arr));
            }
            else{
            	mc.setProperty('requireticket',true);
            }
            
            // Function to check if Cod is present in errorsNotRequireTicket.
            function checkRequireTicket(arr){
             for(i=0;i<arr.length;i++){
             	if(mc.getProperty('cgi-error-codigo')==arr[i])
             	{
             		return false;
             	}
             }
             return true;
            }]]></script>-->
    <log description="requireticket" level="custom">
        <property expression="$ctx:requireticket" name="requireticket"/>
    </log>
    <filter regex="false" source="$ctx:requireticket">
        <then>
            <clone continueParent="true">
                <target>
                    <sequence>
                        <property description="uri.var.resourcepath" name="uri.var.resourcepath" scope="default" type="STRING" value="TaskProvisioningErrorWithoutTicket"/>
                        <payloadFactory description="Ticket ERROR" media-type="json">
                            <format>{
								"TaskProvisioningErrorWithoutTicket":{
								"uuid":"$1",
								"error":"$2"
								}
								}</format>
                            <args>
                                <arg evaluator="xml" expression="get-property('uuid')"/>
                                <arg evaluator="xml" expression="get-property('cgi-error-mensaje')"/>
                            </args>
                        </payloadFactory>
                        <sequence key="GITareas_Seq"/>
                        <drop/>
                    </sequence>
                </target>
            </clone>
        </then>
        <else>
            <sequence key="GIHelpDesk_TicketPayload_Seq"/>
            <log description="Incident Request" level="full"/>
            <sequence key="GIHelpDesk_CreateTicket_Seq"/>
        </else>
    </filter>
</sequence>
