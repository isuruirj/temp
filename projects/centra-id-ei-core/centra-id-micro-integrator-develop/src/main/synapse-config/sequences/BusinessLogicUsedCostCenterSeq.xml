<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessLogicUsedCostCenterSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:tem="http://tempuri.org/">
    <log level="custom" category="INFO">
        <property name="BusinessLogicUsedCostCenterSeq" value="Inicio..." />
    </log>
    <property name="id" expression="$ctx:query.param.id" />
    <filter regex="true" source="boolean($ctx:id)">
        <then>
            <payloadFactory media-type="xml">
                <format>
                    <tem:entities xmlns:tem="http://tempuri.org/">
                        <tem:entity>
                            <name>UserDataSimple</name>
                            <relation>costCenterId</relation>
                            <package>identity</package>
                            <message>Centro de costo esta siendo utilizado por usuarios</message>
                        </tem:entity>
                        <tem:entity>
                            <name>CostCenter</name>
                            <relation>parent.id</relation>
                            <package>company</package>
                            <message>Centro de costo esta siendo utilizado como referencias de otros centros de costos</message>
                        </tem:entity>
                    </tem:entities>
                </format>
                <args />
            </payloadFactory>
            <property name="result" scope="default">
                <result />
            </property>
            <iterate expression="//tem:entity" id="entitiesId">
                <target>
                    <sequence>
                        <property name="name" expression="//*:name" />
                        <property name="relation" expression="//*:relation" />
                        <property name="package" expression="//*:package" />
                        <property name="message" expression="//*:message" />
                        <property name="uri.var.url" expression="fn:concat($ctx:uri.var.enterpriseIntegratorHost,'/api.centraid/',$ctx:package,'/',$ctx:name,'/count?',$ctx:relation,'=',$ctx:id)" />
                        <call>
                            <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.url}" />
                        </call>
                        <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                            <then>
                                <filter regex="false" source="//count = 0">
                                    <then>
                                        <payloadFactory media-type="json">
                                            <format>
                                                {
                                                    "error" : "$1"
                                                }
                                            </format>
                                            <args>
                                                <arg evaluator="xml" expression="$ctx:message" />
                                            </args>
                                        </payloadFactory>
                                    </then>
                                    <else>
                                        <payloadFactory media-type="json">
                                            <format>
                                                {
                                                    "ok" : "$1"
                                                }
                                            </format>
                                            <args>
                                                <arg evaluator="xml" expression="$ctx:message" />
                                            </args>
                                        </payloadFactory>
                                    </else>
                                </filter>
                            </then>
                            <else>
                                <payloadFactory media-type="json">
                                    <format>
                                                {
                                                    "error" : "$1"
                                                }
                                    </format>
                                    <args>
                                        <arg evaluator="xml" expression="$ctx:message" />
                                    </args>
                                </payloadFactory>
                            </else>
                        </filter>
                    </sequence>
                </target>
            </iterate>
            <aggregate id="entitiesId">
                <completeCondition>
                    <messageCount min="-1" max="-1" />
                </completeCondition>
                <onComplete expression="$body/*[1]" enclosingElementProperty="result">
                    <log level="full" category="DEBUG">
                        <property name="BusinessLogicUsedCatalogSeq" value="OK" />
                    </log>
                </onComplete>
            </aggregate>
        </then>
        <else>
            <payloadFactory media-type="json">
                <format>
                    {
                        "result": "-1",
                        "message" : "id is missing"
                    }
                </format>
                <args />
            </payloadFactory>
        </else>
    </filter>
    <property name="messageType" scope="axis2" type="STRING" value="application/json" />
    <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
    <log level="custom" category="INFO">
        <property name="BusinessLogicUsedCostCenterSeq" value="Fin..." />
    </log>
</sequence>