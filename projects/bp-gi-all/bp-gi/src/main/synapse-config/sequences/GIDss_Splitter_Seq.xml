<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GIDss_Splitter_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIDss_Splitter_Seq --------------------"/>
    </log>
    <!-- <clone continueParent="true">
        <target>
            <sequence>
                <payloadFactory media-type="xml">
                    <format>
                        <p:Estado_Procedure xmlns:p="http://ws.wso2.org/dataservice"/>
                    </format>
                    <args/>
                </payloadFactory>
                <header name="Action" scope="default" value="urn:Estado_Procedure"/>
                <header name="SOAPAction" scope="transport" value="urn:Estado_Procedure"/>
                <log level="custom">
                    <property expression="$body/*" name="DSS _ Antes Estado_Procedure "/>
                    <property expression="get-property('Action')" name="Action Estado_Procedure "/>
                </log>
                <call>
                    <endpoint key="GIDss_GIdentidades_EP"/>
                </call>
                <log level="custom">
                    <property expression="$body/*" name="DSS _ Despues Estado_Procedure "/>
                </log>
                <drop/>
            </sequence>
        </target>
    </clone> -->
    <call>
        <endpoint key="GIDss_GIdentidades_EP"/>
    </call>
    <property description="Mensajes_Reprocesar" expression="//*[local-name()='Envelope']" name="Mensajes_Reprocesar" scope="default" type="STRING"/>
    <property description="countRequests" expression="count(//*[local-name()='Mensaje'])" name="countRequests" scope="default" type="STRING"/>
    <log level="custom">
        <property expression="get-property('countRequests')" name="Count Request"/>
    </log>
    <iterate expression="//*[local-name()='Mensaje']" id="IterateMsgIdentidades" sequential="true">
        <target>
        	<sequence>
            	<!-- Filter row count = 1 -->
            	<property name="ROW_GUID" expression="$body/dss:Mensaje/dss:Guid/text()" xmlns:dss="http://ws.wso2.org/dataservice" />
            	<property name="ROW_VERSION" expression="$body/dss:Mensaje/dss:row_version/text()" xmlns:dss="http://ws.wso2.org/dataservice" />
            	<property name="NEW_ROW_VERSION" expression="string(number($body/dss:Mensaje/dss:row_version/text())+1)" xmlns:dss="http://ws.wso2.org/dataservice" />
            	<!-- Main logic extracted into a separate sequence to handle errors differently -->
            	<sequence key="GIDss_Splitter_RecordProcess_Seq"/>
            </sequence>
        </target>
    </iterate>
    <aggregate id="IterateMsgIdentidades">
        <completeCondition timeout="10">
            <messageCount max="{get-property('countRequests')}" min="{get-property('countRequests')}"/>
        </completeCondition>
        <onComplete expression="/s11:Envelope/s11:Body/child::*[position()=1] | /s12:Envelope/s12:Body/child::*[position()=1]" xmlns:s11="http://schemas.xmlsoap.org/soap/envelope/" xmlns:s12="http://www.w3.org/2003/05/soap-envelope">
            <drop/>
        </onComplete>
    </aggregate>
</sequence>
