<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GIHelpDesk_CreateTicket_Seq" onError="GIHandle_Runtime_Error_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIHelpDesk_CreateTicket_Seq --------------------"/>
        <property expression="get-property('cgi-error-codigo')" name="cgi-error-codigo"/>
        <property expression="get-property('cgi-error-mensaje')" name="cgi-error-mensaje"/>
        <property expression="get-property('scimResponse')" name="scimResponse"/>
    </log>
    <property description="seqName" name="seqName" scope="default" type="STRING" value="GIHelpDesk_CreateTicket_Seq"/>
    <header name="Action" scope="default" value="Create"/>
    <sequence key="GIHelpDesk_API_Seq"/>
    <filter regex=".*20.*" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <enrich description="Store Incident Response">
                <source clone="true" type="body"/>
                <target property="incident_response" type="property"/>
            </enrich>
            <property description="IncidentID" expression="$body//ns:CreateIM_IncidentResponse/ns:model/ns:keys/ns:IncidentID" name="IncidentID" scope="default" type="STRING" xmlns:ns="http://schemas.hp.com/SM/7"/>
            <log description="Log Incident Response" level="custom">
                <property expression="get-property('IncidentID')" name="IncidentID"/>
                <property expression="get-property('incident_response')" name="incident_response"/>
            </log>
            <sequence key="GIHelpDesk_UpdateTicket_Seq"/>
            <log description="seq" level="custom">
                <property name="msg" value="-------------------- GIHelpDesk_CreateTicket_Seq --------------------"/>
            </log>
            <header name="Action" scope="default" value="urn:Update_HPTicket"/>
            <property description="incidentDate" expression="get-property(&quot;SYSTEM_DATE&quot;, &quot;yyyy-MM-dd'T'HH:mm:ss.SSSXXX&quot;)" name="incidentDate" scope="default" type="STRING"/>
            <payloadFactory description="Update HPTicket:GIRecovery_DSS" media-type="xml">
                <format key="gov:pichincha/Update_HPTicket.xml"/>
                <args>
                    <arg evaluator="xml" expression="$ctx:GUID"/>
                    <arg value="F"/>
                    <arg evaluator="xml" expression="$ctx:IncidentID"/>
                    <arg evaluator="xml" expression="base64Encode($ctx:incident_response)"/>
                    <arg evaluator="xml" expression="get-property(&quot;SYSTEM_DATE&quot;, &quot;yyyy-MM-dd'T'HH:mm:ss.SSSXXX&quot;)"/>
                    <arg value="Ok"/>
                    <arg value="hp-logs"/>
                </args>
            </payloadFactory>
            <log description="Update HPTicket:GIRecovery_DSS" level="full"/>
            <call>
                <endpoint key="GIDss_GIdentidades_EP"/>
            </call>
            <payloadFactory description="Ticket OK" media-type="json">
                <format>
                {
								"TaskProvisioningError": {
								"uuid": "$1",
								"ticketDate": "$2",
								"ticketNumber": "$3",
								"ticketContent": "$4",
								"ticketError": "$5"
								}
								}
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:uuid"/>
                    <arg evaluator="xml" expression="$ctx:incidentDate"/>
                    <arg evaluator="xml" expression="$ctx:IncidentID"/>
                    <arg evaluator="xml" expression="base64Encode($ctx:description)"/>
                    <arg value="ERROR TICKET GENERADO OK"/>
                </args>
            </payloadFactory>
        </then>
        <else>
            <payloadFactory description="Ticket ERROR" media-type="json">
                <format>{
								"TaskProvisioningError": {
								"uuid": "$1",
								"ticketDate": "$2",
								"ticketNumber": "$3",
								"ticketContent": "$4",
								"ticketError": "$5"
								}
								}
							</format>
                <args>
                    <arg evaluator="xml" expression="$ctx:uuid"/>
                    <arg evaluator="xml" expression="$ctx:incidentDate"/>
                    <arg value="0"/>
                    <arg evaluator="xml" expression="base64Encode($ctx:description)"/>
                    <arg value="ERROR TICKET NO GENERADO"/>
                </args>
            </payloadFactory>
        </else>
    </filter>
    <property description="uri.var.resourcepath" name="uri.var.resourcepath" scope="default" type="STRING" value="TaskProvisioningError"/>
    <sequence key="GITareas_Seq"/>
</sequence>
