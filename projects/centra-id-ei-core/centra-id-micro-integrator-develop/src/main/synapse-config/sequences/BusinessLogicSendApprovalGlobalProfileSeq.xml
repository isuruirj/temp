<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessLogicSendApprovalGlobalProfileSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="full" category="INFO">
        <property name="BusinessLogicSendApprovalGlobalProfileSeq" value="Inicio..." />
    </log>
    <property name="messageType" value="application/json" scope="axis2" />
    <property expression="$body/*[1]" name="payload" scope="default" type="STRING" />
    <script language="js">
        <![CDATA[var payload = mc.getProperty("payload");mc.setPayloadJSON(payload);]]>
    </script>
    <property name="uri.var.globalProfileId" expression="//globalProfileId" />
    <log level="full" category="INFO">
        <property name="BusinessLogicSendApprovalGlobalProfileSeq" value="Inicio.2.." />
        <property name="uri.var.globalProfileId" expression="$ctx:uri.var.globalProfileId" />
    </log>
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/GlobalProfile/0/1?id={uri.var.globalProfileId}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="globalProfile" expression="$body//*" scope="default" type="OM" />
            <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
            <property name="Accept" scope="transport" type="STRING" value="application/xml" />
            <payloadFactory media-type="xml">
                <format>
                    <ci:update_all_query_operation xmlns:ci="centra-id.com">
                        <ci:table>SCH_CENTRA_ID.GLOBAL_PROFILES</ci:table>
                        <ci:set>STATUS='PARA APROBACIÃ“N'</ci:set>
                        <ci:where>VALID=1 AND ID=$1</ci:where>
                    </ci:update_all_query_operation>
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:uri.var.globalProfileId" />
                </args>
            </payloadFactory>
            <call>
                <endpoint template="HTTPEndpointPutTemplate" uri="{uri.var.dataServiceHost}/UsersDSS.HTTPEndpoint/updateAll" />
            </call>
            <!-- recuperar los usuarios que tiene el cargo del propietario -->
            <property name="uri.var.positionId" expression="$ctx:globalProfile//globalProfile/catalogPositionOwner/id/text()" />
            <call>
                <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSimple?catalogPositionId={uri.var.positionId}" />
            </call>
            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <filter regex="true" source="boolean(//userDataSimpleList/userDataSimple/id/text())">
                        <then>
                            <foreach expression="//userDataSimple">
                                <sequence>
                                    <!-- Enviar mail -->
                                    <property name="mail" expression="//mail" />
                                    <property name="identification" expression="//identification" />
                                    <call-template target="GetCurrentDateFormatTemplate" />
                                    <payloadFactory media-type="json">
                                        <format>
                                                [
                                                    {
                                                        "campo": "Generado",
                                                        "valor": "$1"
                                                    },
                                                    {
                                                        "campo": "codigo",
                                                        "valor": "$2"
                                                    },

                                                    {
                                                        "campo": "nombre",
                                                        "valor": "$3"
                                                    },
                                                    {
                                                        "campo": "idTicket",
                                                        "valor": "$4"
                                                    }
                                                ]                                    
                                            </format>
                                        <args>
                                            <arg evaluator="xml" expression="get-property('currentDate')" />
                                            <arg evaluator="xml" expression="$ctx:globalProfile//globalProfile/code" />
                                            <arg evaluator="xml" expression="$ctx:globalProfile//globalProfile/name" />
                                            <arg evaluator="xml" expression="$ctx:globalProfile//globalProfile/associatedTicketNumber" />
                                        </args>
                                    </payloadFactory>
                                    <property name="message" expression="json-eval($)" />
                                    <property name="uuid" expression="fn:substring-after(get-property('MessageID'), 'urn:uuid:')" />
                                    <call-template target="SendMailSeqTemplate">
                                        <with-param name="templateType" value="Plantilla_Email_AprobacionSolicitudCreacionPerfilGlobal" />
                                        <with-param name="toAddress" value="{get-property('mail')}" />
                                        <with-param name="identification" value="{get-property('identification')}" />
                                        <with-param name="message" value="{get-property('message')}" />
                                        <with-param name="attachedName" value="X" />
                                        <with-param name="attachedBase64" value="X" />
                                        <with-param name="uuid" value="{get-property('uuid')}" />
                                        <with-param name="guid" value="{get-property('uuid')}" />
                                    </call-template>
                                </sequence>
                            </foreach>
                        </then>
                    </filter>
                    <payloadFactory media-type="json">
                        <format>
                                    {
                                        "result":  {
                                            "code" : 0,
                                            "message" : "Operation performed successfully"
                                        }
                                    }
                                </format>
                        <args />
                    </payloadFactory>
                </then>
                <else>
                    <property name="fault" value="Error get UserDataSimple" />
                    <sequence key="FaultSeq" />
                </else>
            </filter>
        </then>
        <else>
            <property name="fault" value="Error get GlobalProfile" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <property name="messageType" scope="axis2" type="STRING" value="application/json" />
    <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
    <log level="custom" category="DEBUG">
        <property name="BusinessLogicSendApprovalGlobalProfileSeq" value="Fin..." />
    </log>
</sequence>