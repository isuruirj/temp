<?xml version="1.0" encoding="UTF-8"?>
<sequence name="RecalculateCreateSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="RecalculateCreateSeq" value="Inicio.." />
        <property name="X-Forwarded-For" expression="$ctx:X-Forwarded-For" />
        <property name="UserName" expression="$ctx:UserName" />
    </log>
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/TransactionalProfileSimple?globalProfileId={uri.var.globalProfileId}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <!-- No realiza recalculo, grabar los perfiles transacionales de CREACION -->
            <log level="custom" category="DEBUG">
                <property name="RecalculateCreateSeq" value="Inicio.2." />
            </log>
            <filter regex="true" source="boolean(//transactionalProfileSimple)">
                <then>
                    <iterate expression="//transactionalProfileSimple" id="transactionalProfileSimpleId">
                        <target>
                            <sequence>
                                <sequence key="RecalculateTaskSeq" />
                            </sequence>
                        </target>
                    </iterate>
                    <aggregate id="transactionalProfileSimpleId">
                        <completeCondition>
                            <messageCount min="-1" max="-1" />
                        </completeCondition>
                        <onComplete expression="$body/*[1]">
                            <log level="custom" category="TRACE">
                                <property name="agregado" value="ok" />
                            </log>
                        </onComplete>
                    </aggregate>
                    <log level="custom" category="DEBUG">
                        <property name="RecalculateCreateSeq" value="Inicio.3." />
                    </log>
                    <!-- Especifica las dependencias entre aplicacion-->
                    <sequence key="RecalculateTaskDependencySeq" />
                    <!-- Enviar a colas de aprovisionamiento -->
                    <log level="custom" category="DEBUG">
                        <property name="RecalculateCreateSeq" value="Inicio.4." />
                    </log>
                    <sequence key="ProvisioningSeq" />
                    <log level="custom" category="DEBUG">
                        <property name="RecalculateCreateSeq" value="Inicio.5" />
                    </log>
                </then>
            </filter>
        </then>
        <else>
            <property name="fault" value="RecalculateSeq: error when get TransactionalProfile" />
            <sequence key="FaultUserDataSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="X-Forwarded-For" expression="$ctx:X-Forwarded-For" />
        <property name="UserName" expression="$ctx:UserName" />
        <property name="RecalculateCreateSeq" value="Fin.." />
    </log>
</sequence>