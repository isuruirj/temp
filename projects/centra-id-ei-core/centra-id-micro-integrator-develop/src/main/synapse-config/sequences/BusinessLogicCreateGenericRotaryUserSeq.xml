<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessLogicCreateGenericRotaryUserSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="BusinessLogicCreateGenericRotaryUserSeq" value="Inicio..." />
    </log>
    <property name="messageType" value="application/json" scope="axis2" />
    <property expression="$body/*[1]" name="payload" scope="default" type="STRING" />
    <script language="js">
        <![CDATA[var payload = mc.getProperty("payload");mc.setPayloadJSON(payload);]]>
    </script>
    <!-- tranformar JSON to XML -->
    <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
    <property name="Accept" scope="transport" type="STRING" value="application/xml" />
    <!-- Salvar datos -->
    <property name="X-Forwarded-For" expression="//xForwardedForAction" />
    <property name="UserName" expression="//usernameAction" />
    <property name="uri.var.company" expression="//company" />
    <property name="uri.var.costCenter" expression="//costCenter" />
    <property name="uri.var.userTypeCode" expression="//userTypeCode" />
    <property name="uri.var.userSubtypeCode" expression="//userSubtypeCode" />
    <property name="endDate" expression="//endDate" />
    <property name="guid" expression="fn:substring-after(get-property('MessageID'), 'urn:uuid:')" />
    <property name="justification" expression="//justification" />
    <property name="uri.var.responsibleUser" expression="//responsibleUser" />
    <property name="uri.var.profile" expression="//profile" />
    <property name="typeRotary" expression="//typeRotary" />
    <!-- Recuperar compania -->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/company/Company?code={uri.var.company}" />
    </call>
    <property name="companyId" expression="//companyList/company/id" />
    <!-- Recuperar centro costo-->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/company/CostCenter?code={uri.var.costCenter}&amp;company.code={uri.var.company}" />
    </call>
    <property name="costCenterId" expression="//costCenterList/costCenter/id" />
    <!-- Recuperar tipo de usuario-->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/TypeUser?code={uri.var.userTypeCode}&amp;type=T" />
    </call>
    <property name="userTypeId" expression="//typeUserList/typeUser/id" />
    <!-- Recuperar subtipo de usuario-->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/TypeUser?code={uri.var.userSubtypeCode}&amp;type=S" />
    </call>
    <property name="userSubtypeId" expression="//typeUserList/typeUser/id" />
    <!-- Recuperar perfil global -->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/GlobalProfile?code={uri.var.profile}" />
    </call>
    <property name="globalProfileId" expression="//globalProfileList/globalProfile/id" />
    <!-- Recuperar el tipo de identicacion para pasaporte -->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog?code=P&amp;catalogType=TIPIDE" />
    </call>
    <property name="catalogIdentificationTypeId" expression="//catalogList/catalog/id" />
    <!-- Recuperar userdata contraparte banco  -->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSimple/0/1?employeeCode={uri.var.responsibleUser}" />
    </call>
    <property name="userdataId" expression="//userDataSimpleList/userDataSimple/id/text()" />
    <property name="firstSurname" expression="get-property('FIRST_NAME_ROTARY_USER')" />
    <property name="secondSurname" expression="get-property('SECOND_SURNAME_ROTARY_USER')" />
    <property name="firstName" expression="$ctx:typeRotary" />
    <property name="middleName" expression="$ctx:uri.var.costCenter" />
    <property name="names" expression="fn:concat($ctx:firstSurname,' ',$ctx:secondSurname,' ',$ctx:firstName,' ',$ctx:middleName)" />
    <property name="identity" expression="get-property('IDENTIFICATION_ROTARY_USER')" />
    <property name="personalEmail" expression="//userDataSimpleList/userDataSimple/mail/text()" />
    <property name="cellphoneNumber" expression="//userDataSimpleList/userDataSimple/mobile/text()" />
    <property name="divisionId" expression="//userDataSimpleList/userDataSimple/catalogDivisionId/text()" />
    <property name="areaId" expression="//userDataSimpleList/userDataSimple/catalogAreaId/text()" />
    <property name="departmentId" expression="//userDataSimpleList/userDataSimple/catalogDepartmentId/text()" />
    <property name="positionId" expression="//userDataSimpleList/userDataSimple/catalogPositionId/text()" />
    <!-- Obtener fecha actual -->
    <call-template target="GetCurrentDateTemplate" />
    <log level="custom" category="DEBUG">
        <property name="BusinessLogicCreateGenericRotaryUserSeq" value="Inicio.1.1." />
        <property name="firstSurname" expression="get-property('firstSurname')" />
        <property name="middleName" expression="get-property('middleName')" />
        <property name="firstName" expression="get-property('firstName')" />
        <property name="secondSurname" expression="get-property('secondSurname')" />
        <property name="names" expression="get-property('names')" />
        <property name="identity" expression="get-property('identity')" />
        <property name="currentDate" expression="get-property('currentDate')" />
        <property name="personalEmail" expression="get-property('personalEmail')" />
        <property name="currentDate" expression="get-property('currentDate')" />
        <property name="guid" expression="get-property('guid')" />
        <property name="currentDate" expression="get-property('currentDate')" />
        <property name="guid" expression="get-property('guid')" />
        <property name="cellphoneNumber" expression="get-property('cellphoneNumber')" />
        <property name="companyId" expression="get-property('companyId')" />
        <property name="divisionId" expression="get-property('divisionId')" />
        <property name="areaId" expression="get-property('areaId')" />
        <property name="departmentId" expression="get-property('departmentId')" />
        <property name="positionId" expression="get-property('positionId')" />
        <property name="costCenterId" expression="get-property('costCenterId')" />
        <property name="userTypeId" expression="get-property('userTypeId')" />
        <property name="userSubtypeId" expression="get-property('userSubtypeId')" />
        <property name="globalProfileId" expression="get-property('globalProfileId')" />
        <property name="userdataId" expression="get-property('userdataId')" />
        <property name="justification" expression="get-property('justification')" />
        <property name="catalogIdentificationTypeId" expression="get-property('catalogIdentificationTypeId')" />
    </log>
    <!-- Crear Usuario-->
    <payloadFactory media-type="json">
        <format>
            {
                "userData": {
                    "username": "",
                    "workerCode": "",
                    "employeeFirstSurname": "$1",
                    "employeeSecondSurname": "$2",
                    "employeeFirstName": "$3",
                    "employeeSecondName": "$4",
                    "employeeCompleteName": "$5",
                    "identification": "$6",
                    "groupingCode": "",
                    "subsidiaryCode": "",
                    "subsidiaryName": "",
                    "locationName": "",
                    "hierarchicalLevel": "100",
                    "depositAccountNumber": "",
                    "employeeIncomeDate": "$7",
                    "employeeDepartureDate": null,
                    "employeeStatus": "ACTIVO",
                    "employeeCode": "0000000000",
                    "mail" : "X",
                    "usernameView" : "$8",
                    "registrationDate": "$9",
                    "guid": "$10",
                    "typeEvent": "C",
                    "dataDate": "$11",
                    "uuid": "$12",
                    "provisionDate": null,
                    "mobile": "$13",
                    "suspensionStartDate": null,
                    "suspensionEndDate": null,
                    "suspensionType": null,
                    "validationStartDate": null,
                    "validationEndDate": null,
                    "endingWorkDate": null,
                    "company": {
                        "id": $14
                    },
                    "catalogDivision": {
                        "id": $15
                    },
                    "catalogArea": {
                        "id": $16
                    },
                    "catalogDepartment": {
                        "id" : $17
                    },
                    "catalogPosition": {
                        "id": $18
                    },
                    "costCenter": {
                        "id": $19
                    },
                    "typeUser": {
                        "id": $20
                    },
                    "subtypeUser": {
                        "id": $21
                    },
                    "catalogIdentificationType": {
                        "id": $22
                    },
                    "globalProfile": {
                        "id": $23
                    },
                    "userdataBankCounterpart": null,
                    "userdataResponsibleUser": {
                        "id": $24
                    },
                    "userdataSupervisor": null,
                    "suspensionReason" : "$25",
                    "counterGenericRotary" : 0,
                    "counterGenericMail" : 0,
                    "typeRotary" : "$26",
                    "filter" : "X",
                    "origin" : "Creación / Eliminación Usuario Genérico"
                }
            }
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('firstSurname')" />
            <arg evaluator="xml" expression="get-property('middleName')" />
            <arg evaluator="xml" expression="get-property('firstName')" />
            <arg evaluator="xml" expression="get-property('secondSurname')" />
            <arg evaluator="xml" expression="get-property('names')" />
            <arg evaluator="xml" expression="get-property('identity')" />
            <arg evaluator="xml" expression="get-property('currentDate')" />
            <arg evaluator="xml" expression="get-property('personalEmail')" />
            <arg evaluator="xml" expression="get-property('currentDate')" />
            <arg evaluator="xml" expression="get-property('guid')" />
            <arg evaluator="xml" expression="get-property('currentDate')" />
            <arg evaluator="xml" expression="get-property('guid')" />
            <arg evaluator="xml" expression="get-property('cellphoneNumber')" />
            <arg evaluator="xml" expression="get-property('companyId')" />
            <arg evaluator="xml" expression="get-property('divisionId')" />
            <arg evaluator="xml" expression="get-property('areaId')" />
            <arg evaluator="xml" expression="get-property('departmentId')" />
            <arg evaluator="xml" expression="get-property('positionId')" />
            <arg evaluator="xml" expression="get-property('costCenterId')" />
            <arg evaluator="xml" expression="get-property('userTypeId')" />
            <arg evaluator="xml" expression="get-property('userSubtypeId')" />
            <arg evaluator="xml" expression="get-property('catalogIdentificationTypeId')" />
            <arg evaluator="xml" expression="get-property('globalProfileId')" />
            <arg evaluator="xml" expression="get-property('userdataId')" />
            <arg evaluator="xml" expression="get-property('justification')" />
            <arg evaluator="xml" expression="get-property('typeRotary')" />
        </args>
    </payloadFactory>
    <property name="X-Forwarded-For" scope="transport" expression="$ctx:X-Forwarded-For" />
    <property name="UserName" scope="transport" expression="$ctx:UserName" />
    <call>
        <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserData" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="ContentType" value="application/json" scope="axis2" />
            <property name="messageType" value="application/json" scope="axis2" />
        </then>
        <else>
            <property name="fault" value="Error create generic rotary user" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="BusinessLogicCreateGenericRotaryUserSeq" value="Fin..." />
    </log>
</sequence>