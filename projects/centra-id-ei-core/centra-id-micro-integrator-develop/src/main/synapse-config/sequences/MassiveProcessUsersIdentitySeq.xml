<?xml version="1.0" encoding="UTF-8"?>
<sequence name="MassiveProcessUsersIdentitySeq" onError="FaultMassiveProcessUsersSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:cen="centra-id.com">
    <log level="custom" separator=" | " category="DEBUG">
        <property name="MassiveProcessUsersIdentitySeq" value="Inicio...1" />
    </log>
    <property name="uri.var.guid" expression="get-property('guid')" />
    <!-- Crear usuarios en identity-->
    <header action="remove" name="Content-Type" scope="transport" />
    <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
    <log level="custom" separator=" | " category="DEBUG">
        <property name="MassiveProcessUsersIdentitySeq:guid" expression="get-property('guid')" />
    </log>
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.dataServiceHost}/MassiveProcessDSS.HTTPEndpoint/getByGuidAndTypeActionMassiveProcess?guid={uri.var.guid}&amp;typeAction=C" />
    </call>
    <property name="findData" expression="//cen:MassiveProcesses/cen:MassiveProcess" xmlns:cen="centra-id.com" />
    <filter regex="true" source="boolean(get-property('findData'))">
        <then>
            <iterate attachPath="//cen:MassiveProcesses" expression="//cen:MassiveProcesses/cen:MassiveProcess" preservePayload="true" sequential="true" xmlns:cen="centra-id.com">
                <target>
                    <sequence>
                        <sequence key="MassiveProcessUsersIdentityCreateSeq" />
                    </sequence>
                </target>
            </iterate>
        </then>
    </filter>
    <!-- Actualizar usuarios en identity-->
    <header action="remove" name="Content-Type" scope="transport" />
    <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
    <call>
        <endpoint name="MassiveProcessDSS.Endpoint" template="HTTPEndpointGetTemplate" uri="{uri.var.dataServiceHost}/MassiveProcessDSS.HTTPEndpoint/getByGuidAndTypeActionMassiveProcess?guid={uri.var.guid}&amp;typeAction=U" />
    </call>
    <property name="findData" expression="//cen:MassiveProcesses/cen:MassiveProcess" xmlns:cen="centra-id.com" />
    <log level="custom" separator=" | " category="DEBUG">
        <property name="MassiveProcessUsersIdentitySeq" expression="fn:concat('Registrar IS - Actualizar: ',get-property('findData'))" />
    </log>
    <filter regex="true" source="boolean(get-property('findData'))">
        <then>
            <iterate attachPath="//cen:MassiveProcesses" expression="//cen:MassiveProcesses/cen:MassiveProcess" preservePayload="true" sequential="true" xmlns:cen="centra-id.com">
                <target>
                    <sequence>
                        <sequence key="MassiveProcessUsersIdentityUpdateSeq" />
                    </sequence>
                </target>
            </iterate>
        </then>
    </filter>
    <!-- Eliminar usuarios en identity-->
    <header action="remove" name="Content-Type" scope="transport" />
    <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
    <call>
        <endpoint name="MassiveProcessDSS.Endpoint" template="HTTPEndpointGetTemplate" uri="{uri.var.dataServiceHost}/MassiveProcessDSS.HTTPEndpoint/getByGuidAndTypeActionMassiveProcess?guid={uri.var.guid}&amp;typeAction=D" />
    </call>
    <property name="findData" expression="//cen:MassiveProcesses/cen:MassiveProcess" xmlns:cen="centra-id.com" />
    <log level="custom" separator=" | " category="DEBUG">
        <property name="MassiveProcessUsersIdentitySeq" expression="fn:concat('Registrar IS - Eliminar: ',get-property('findData'))" />
    </log>
    <filter regex="true" source="boolean(get-property('findData'))">
        <then>
            <iterate attachPath="//cen:MassiveProcesses" expression="//cen:MassiveProcesses/cen:MassiveProcess" preservePayload="true" sequential="true" xmlns:cen="centra-id.com">
                <target>
                    <sequence>
                        <sequence key="MassiveProcessUsersIdentityDeleteSeq" />
                    </sequence>
                </target>
            </iterate>
        </then>
    </filter>
    <log level="custom" separator="| ">
        <property name="MassiveProcessUsersIdentitySeq" value="Fin..." />
    </log>
</sequence>