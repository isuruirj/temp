<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GIReply_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIReply_Seq --------------------"/>
        <property expression="get-property('GUID')" name="GUID"/>
        <property expression="get-property('cgi-error-codigo')" name="cgi-error-codigo"/>
    </log>
    <filter regex="0" source="get-property('cgi-error-codigo')">
        <then>
            <log description="Message OK" level="custom">
                <property expression="get-property('ESTADO')" name="ESTADO"/>
                <property expression="$body" name="Message OK"/>
            </log>
            <switch source="get-property('ESTADO')">
                <case regex="R">
                    <property description="MENSAJE_RESPUESTA" expression="$env" name="MENSAJE_RESPUESTA" scope="default" type="STRING"/>
                    <property description="MENSAJE_RESPUESTA_VALORES" expression="$env" name="MENSAJE_RESPUESTA_VALORES" scope="default" type="OM"/>
                    <payloadFactory description="Estado F" media-type="xml">
                        <format key="gov:/pichincha/Update_GIdentidad.xml"/>
                        <args>
                            <arg evaluator="xml" expression="get-property('GUID')"/>
                            <arg value="1"/>
                            <arg value="F"/>
                            <arg evaluator="xml" expression="get-property('REQUEST_ORIGIN')"/>
                            <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_PETICION'))"/>
                            <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_RESPUESTA'))"/>
                            <arg evaluator="xml" expression="get-property('SOAP_ACTION_REQUEST')"/>
                            <arg value="0"/>
                            <arg evaluator="xml" expression="$axis2:HTTP_SC"/>
                            <arg evaluator="xml" expression="get-property('MENSAJE_PETICION_VALORES')"/>
                            <arg evaluator="xml" expression="get-property('MENSAJE_RESPUESTA_VALORES')"/>
                        </args>
                    </payloadFactory>
                    <sequence key="GIUpdate_Reproceso_Seq"/>
                    <clone continueParent="true" description="Continue Parent">
                        <target>
                            <sequence>
                                <property description="uri.var.resourcepath" name="uri.var.resourcepath" scope="default" type="STRING" value="TaskProvisioningOk"/>
                                <payloadFactory description="Tareas Payload Ok" media-type="json">
                                    <format>{
							"taskProvisioningOK": {
							"uuid": "$1",
							"provisioningDate": "$2",
							"provisioningComment": "$3"
							}
							}</format>
                                    <args>
                                        <arg evaluator="xml" expression="get-property('uuid')"/>
                                        <arg evaluator="xml" expression="get-property(&quot;SYSTEM_DATE&quot;, &quot;yyyy-MM-dd'T'HH:mm:ss.SSSXXX&quot;)"/>
                                        <arg value="APROVISIONADO"/>
                                    </args>
                                </payloadFactory>
                                <sequence key="GITareas_Seq"/>
                                <drop/>
                            </sequence>
                        </target>
                    </clone>
                </case>
                <case regex="O">
                    <clone continueParent="true" description="">
                        <target>
                            <sequence>
                                <property description="uri.var.resourcepath" name="uri.var.resourcepath" scope="default" type="STRING" value="TaskProvisioningOk"/>
                                <payloadFactory description="Tareas Payload Ok" media-type="json">
                                    <format>{
							"taskProvisioningOK": {
							"uuid": "$1",
							"provisioningDate": "$2",
							"provisioningComment": "$3"
							}
							}</format>
                                    <args>
                                        <arg evaluator="xml" expression="get-property('uuid')"/>
                                        <arg evaluator="xml" expression="get-property(&quot;SYSTEM_DATE&quot;, &quot;yyyy-MM-dd'T'HH:mm:ss.SSSXXX&quot;)"/>
                                        <arg value="APROVISIONADO"/>
                                    </args>
                                </payloadFactory>
                                <sequence key="GITareas_Seq"/>
                                <sequence key="GIConsulta_Dependientes_Seq"/>
                                <drop/>
                            </sequence>
                        </target>
                    </clone>
                </case>
                <default/>
            </switch>
        </then>
        <else>
            <log description="Message ERROR" level="custom">
                <property expression="get-property('ESTADO')" name="ESTADO"/>
                <property expression="$ctx:GUID" name="GUID ====================="/>
                <property expression="$body" name="Message ERROR"/>
            </log>
            <sequence key="GIFault_Seq"/>
        </else>
    </filter>
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIReply_Seq --------------------"/>
    </log>
    <property description="HTTP_SC:200" name="HTTP_SC" scope="axis2" type="STRING" value="200"/>
    <payloadFactory description="Dummy OK" media-type="xml">
        <format>
            <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                <soapenv:Body>
                    <FinalRespose xmlns="http://tempuri.org/">
                        <Response>
                            <Cod>$1</Cod>
                            <DesError1>$2</DesError1>
                        </Response>
                    </FinalRespose>
                </soapenv:Body>
            </soapenv:Envelope>
        </format>
        <args>
            <arg value="0"/>
            <arg value="Dummy OK"/>
        </args>
    </payloadFactory>
</sequence>
