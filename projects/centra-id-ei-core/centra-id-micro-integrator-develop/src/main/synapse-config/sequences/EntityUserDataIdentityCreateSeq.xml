<?xml version="1.0" encoding="UTF-8"?>
<sequence name="EntityUserDataIdentityCreateSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:ns="http://org.apache.axis2/xsd" xmlns:ax2764="http://common.mgt.user.carbon.wso2.org/xsd">
    <log level="custom" category="DEBUG">
        <property name="EntityUserdataIdentityCreateSeq" value="Inicio.." />
        <property name="userdataId" expression="get-property('uri.var.userdataId')" />
    </log>
    <filter regex="true" source="boolean(get-property('uri.var.userdataId'))">
        <then>
            <!-- recuperar los datos del userdata -->
            <call>
                <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSearch/{uri.var.userdataId}" />
            </call>
            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <property name="mail" expression="//correoElectronico" />
                    <property name="personalMail" expression="//correoElectronicoPersonal" />
                    <property name="movil" expression="//celular" />
                    <property name="identification" expression="//identificacion" />
                    <property name="name" expression="//nombresCompletos" />
                    <property name="uuid" expression="//uuid" />
                    <property name="guid" expression="//guid" />
                    <filter regex="true" source="boolean(//identificacionSupervisor/text())">
                        <then>
                            <property name="identificacionSupervisor" expression="//identificacionSupervisor/text()" />
                            <property name="nombreSupervisor" expression="//nombreSupervisor/text()" />
                        </then>
                    </filter>
                    <filter regex="true" source="boolean(//identificacionContraparte/text())">
                        <then>
                            <property name="identificacionSupervisor" expression="//identificacionContraparte/text()" />
                            <property name="nombreSupervisor" expression="//nombreContraparte/text()" />
                        </then>
                    </filter>
                    <filter regex="true" source="boolean(//identificacionResponsable/text())">
                        <then>
                            <property name="identificacionSupervisor" expression="//identificacionResponsable/text()" />
                            <property name="nombreSupervisor" expression="//nombreResponsable/text()" />
                        </then>
                    </filter>
                    <!-- Crear Usuario -->
                    <payloadFactory media-type="xml">
                        <format>
                            <xsd:addUser xmlns:xsd="http://org.apache.axis2/xsd" xmlns:xsd1="http://common.mgt.user.carbon.wso2.org/xsd">
                                <xsd:userName>$39</xsd:userName>
                                <xsd:password>$40</xsd:password>
                                <xsd:roles>Internal/employee_user</xsd:roles>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoTrabajador</xsd1:claimURI>
                                    <xsd1:value>$1</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/apellidosEmpleado</xsd1:claimURI>
                                    <xsd1:value>$2</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombresEmpleado</xsd1:claimURI>
                                    <xsd1:value>$3</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/identificacion</xsd1:claimURI>
                                    <xsd1:value>$4</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/identificacionSupervisor</xsd1:claimURI>
                                    <xsd1:value>$5</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreSupervisor</xsd1:claimURI>
                                    <xsd1:value>$6</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoCompania</xsd1:claimURI>
                                    <xsd1:value>$7</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreCompania</xsd1:claimURI>
                                    <xsd1:value>$8</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoAgrupacion</xsd1:claimURI>
                                    <xsd1:value>$9</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreAgrupacion</xsd1:claimURI>
                                    <xsd1:value>$10</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoDivision</xsd1:claimURI>
                                    <xsd1:value>$11</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreDivision</xsd1:claimURI>
                                    <xsd1:value>$12</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoDepartamento</xsd1:claimURI>
                                    <xsd1:value>$13</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreDepartamento</xsd1:claimURI>
                                    <xsd1:value>$14</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoArea</xsd1:claimURI>
                                    <xsd1:value>$15</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreArea</xsd1:claimURI>
                                    <xsd1:value>$16</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoCentroCosto</xsd1:claimURI>
                                    <xsd1:value>$17</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreCentroCosto</xsd1:claimURI>
                                    <xsd1:value>$18</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreLocalidad</xsd1:claimURI>
                                    <xsd1:value>$19</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreCargo</xsd1:claimURI>
                                    <xsd1:value>$20</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoNivelJerarquico</xsd1:claimURI>
                                    <xsd1:value>$21</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombreNivelJerarquico</xsd1:claimURI>
                                    <xsd1:value>$22</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/numeroCuentaDeposito</xsd1:claimURI>
                                    <xsd1:value>$23</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/fechaEntrada</xsd1:claimURI>
                                    <xsd1:value>$24</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/fechaSalida</xsd1:claimURI>
                                    <xsd1:value>$25</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/estadoEmpleado</xsd1:claimURI>
                                    <xsd1:value>$26</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/celular</xsd1:claimURI>
                                    <xsd1:value>$27</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/codigoEmpleado</xsd1:claimURI>
                                    <xsd1:value>$28</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/tipoUsuario</xsd1:claimURI>
                                    <xsd1:value>$29</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/subTipo</xsd1:claimURI>
                                    <xsd1:value>$30</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/correoElectronico</xsd1:claimURI>
                                    <xsd1:value>$31</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/userDataId</xsd1:claimURI>
                                    <xsd1:value>$32</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/globalProfileCode</xsd1:claimURI>
                                    <xsd1:value>$33</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/globalProfileId</xsd1:claimURI>
                                    <xsd1:value>$34</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/globalProfileName</xsd1:claimURI>
                                    <xsd1:value>$35</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/tipoIdentificacion</xsd1:claimURI>
                                    <xsd1:value>$36</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/username</xsd1:claimURI>
                                    <xsd1:value>$37</xsd1:value>
                                </xsd:claims>
                                <xsd:claims>
                                    <xsd1:claimURI>http://wso2.org/claims/nombres</xsd1:claimURI>
                                    <xsd1:value>$38</xsd1:value>
                                </xsd:claims>
                                <xsd:profileName>default</xsd:profileName>
                            </xsd:addUser>
                        </format>
                        <args>
                            <arg evaluator="xml" expression="//codigoTrabajador/text()" />
                            <arg evaluator="xml" expression="//apellidosEmpleado/text()" />
                            <arg evaluator="xml" expression="//nombresEmpleado/text()" />
                            <arg evaluator="xml" expression="//identificacion/text()" />
                            <arg evaluator="xml" expression="$ctx:identificacionSupervisor" />
                            <arg evaluator="xml" expression="$ctx:nombreSupervisor" />
                            <arg evaluator="xml" expression="//codigoCompania/text()" />
                            <arg evaluator="xml" expression="//nombreCompania/text()" />
                            <arg evaluator="xml" expression="//codigoAgrupacion/text()" />
                            <arg evaluator="xml" expression="//codigoAgrupacion/text()" />
                            <arg evaluator="xml" expression="//codigoDivision/text()" />
                            <arg evaluator="xml" expression="//nombreDivision/text()" />
                            <arg evaluator="xml" expression="//codigoDepartamento/text()" />
                            <arg evaluator="xml" expression="//nombreDepartamento/text()" />
                            <arg evaluator="xml" expression="//codigoArea/text()" />
                            <arg evaluator="xml" expression="//nombreArea/text()" />
                            <arg evaluator="xml" expression="//codigoCentroCosto/text()" />
                            <arg evaluator="xml" expression="//nombreCentroCosto/text()" />
                            <arg evaluator="xml" expression="//nombrelocalidad/text()" />
                            <arg evaluator="xml" expression="//nombreCargo/text()" />
                            <arg evaluator="xml" expression="//codigoNivelJerarquico/text()" />
                            <arg evaluator="xml" expression="//codigoNivelJerarquico/text()" />
                            <arg evaluator="xml" expression="//numeroCuentaDeposito/text()" />
                            <arg evaluator="xml" expression="//fechaIngreso/text()" />
                            <arg evaluator="xml" expression="//fechaSalida/text()" />
                            <arg evaluator="xml" value="ACTIVO" />
                            <arg evaluator="xml" expression="//celular/text()" />
                            <arg evaluator="xml" expression="//codigoEmpleado/text()" />
                            <arg evaluator="xml" expression="//tipousuario/code/text()" />
                            <arg evaluator="xml" expression="//subtipo/code/text()" />
                            <arg evaluator="xml" expression="//correoElectronico/text()" />
                            <arg evaluator="xml" expression="//id/text()" />
                            <arg evaluator="xml" expression="//codigoPerfilGlobal/text()" />
                            <arg evaluator="xml" expression="//idPerfilGlobal/text()" />
                            <arg evaluator="xml" expression="//nombrePerfilGlobal/text()" />
                            <arg evaluator="xml" expression="//tipoIdentificacion/text()" />
                            <arg evaluator="xml" expression="get-property('username')" />
                            <arg evaluator="xml" expression="fn:concat(//apellidosEmpleado/text(),' ',//nombresEmpleado/text())" />
                            <arg evaluator="xml" expression="get-property('username')" />
                            <arg evaluator="xml" expression="get-property('password')" />
                        </args>
                    </payloadFactory>
                    <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
                    <property name="IS_SERVER_USER_DATO" expression="synapse:get-property('IS_SERVER_USER')" scope="default" />
                    <property name="IS_SERVER_PASSWORD_DATO" expression="synapse:get-property('IS_SERVER_PASSWORD')" scope="default" />
                    <property name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:IS_SERVER_USER_DATO,':',$ctx:IS_SERVER_PASSWORD_DATO)))" scope="transport" />
                    <property name="service_ep" expression="fn:concat(get-property('uri.var.identityServerHost'),'/services' ,'/UserAdmin')" />
                    <header name="To" expression="get-property('service_ep')" />
                    <property name="Accept" scope="transport" value="application/xml" />
                    <log level="custom" category="DEBUG">
                        <property name="EntityUserdataIdentityCreateSeq" value="Inicio.2." />
                        <property name="date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss:SSS')" />
                    </log>
                    <call>
                        <endpoint>
                            <default />
                        </endpoint>
                    </call>
                    <log level="custom" category="DEBUG">
                        <property name="EntityUserdataIdentityCreateSeq" value="Inicio.3." />
                        <property name="date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss:SSS')" />
                    </log>
                    <property name="fault" expression="//ns:UserAdminUserAdminException" />
                    <property name="fault2" expression="//faultstring" />
                    <filter regex="true" source="boolean(get-property('fault')) or boolean(get-property('fault2'))">
                        <then>
                            <log level="custom" category="DEBUG">
                                <property name="EntityUserdataIdentityCreateSeq" value="Inicio.4." />
                                <property name="date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss:SSS')" />
                            </log>
                            <property name="fault" expression="fn:concat(get-property('fault'),':',get-property('fault2'))" />
                            <sequence key="FaultSeq" />
                        </then>
                        <else>
                            <!-- Generar QR-->
                            <payloadFactory media-type="xml">
                                <format>
                                    <ser:retrieveSecretKey xmlns:ser="http://services.totp.authenticator.application.identity.carbon.wso2.org">
                                        <ser:username>$1</ser:username>
                                    </ser:retrieveSecretKey>
                                </format>
                                <args>
                                    <arg evaluator="xml" expression="get-property('username')" />
                                </args>
                            </payloadFactory>
                            <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
                            <property name="IS_SERVER_USER_DATO" expression="synapse:get-property('IS_SERVER_USER')" scope="default" />
                            <property name="IS_SERVER_PASSWORD_DATO" expression="synapse:get-property('IS_SERVER_PASSWORD')" scope="default" />
                            <property name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:IS_SERVER_USER_DATO,':',$ctx:IS_SERVER_PASSWORD_DATO)))" scope="transport" />
                            <property name="service_ep_totp" expression="fn:concat(get-property('uri.var.identityServerHost'),'/services' ,'/TOTPAdminService')" />
                            <header name="To" expression="get-property('service_ep_totp')" />
                            <call>
                                <endpoint>
                                    <default />
                                </endpoint>
                            </call>
                            <property name="QR_CODE_SECRET" expression="//*:return" />
                            <property name="QR_CODE_ACCOUNT" expression="get-property('username')" />
                            <sequence key="GenerateQRCodeSeq" />
                            <script language="js">
                                <![CDATA[
                                var file = mc.getProperty('QR_CODE_RESULT');
                                mc.setProperty("qrBase64",file.substring(22));
                                ;]]>
                            </script>
                            <!-- Obtener fecha actual -->
                            <call-template target="GetCurrentDateFormatTemplate" />
                            <!-- Enviar mail -->
                            <payloadFactory media-type="json">
                                <format>
                                    [
                                        {
                                            "campo": "Generado",
                                            "valor": "$1"
                                        },
                                        {
                                            "campo": "tipoIdentificacion",
                                            "valor": "$2"
                                        },

                                        {
                                            "campo": "nombreCompleto",
                                            "valor": "$3"
                                        },
                                        {
                                            "campo": "usuario",
                                            "valor": "$4"
                                        },
                                        {
                                            "campo": "clave",
                                            "valor": "$5"
                                        },
                                        {
                                            "campo": "imagenQr",
                                            "valor": "$6"
                                        },
                                        {
                                            "campo": "secretKey",
                                            "valor": "$7 "
                                        }
                                    ]                                    
                                </format>
                                <args>
                                    <arg evaluator="xml" expression="get-property('currentDate')" />
                                    <arg evaluator="xml" value="CÉDULA" />
                                    <arg evaluator="xml" expression="get-property('name')" />
                                    <arg evaluator="xml" expression="get-property('username')" />
                                    <arg evaluator="xml" expression="get-property('password')" />
                                    <arg evaluator="xml" expression="get-property('qrBase64')" />
                                    <arg evaluator="xml" expression="get-property('QR_CODE_SECRET')" />
                                </args>
                            </payloadFactory>
                            <property name="message" expression="json-eval($)" />
                            <log level="custom" category="DEBUG">
                                <property name="EntityUserdataIdentityCreateSeq" value="Inicio.5." />
                                <property name="toAddress" expression="get-property('personalMail')" />
                                <property name="message" expression="get-property('message')" />
                                <property name="date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss:SSS')" />
                            </log>
                            <call-template target="SendMailSeqTemplate">
                                <with-param name="templateType" value="Plantilla_Email_GeneracionClaveInicial" />
                                <with-param name="toAddress" value="{get-property('personalMail')}" />
                                <with-param name="identification" value="{get-property('identification')}" />
                                <with-param name="message" value="{get-property('message')}" />
                                <with-param name="attachedName" value="X" />
                                <with-param name="attachedBase64" value="X" />
                                <with-param name="uuid" value="{get-property('uuid')}" />
                                <with-param name="guid" value="{get-property('guid')}" />
                            </call-template>
                            <log level="custom" category="DEBUG">
                                <property name="EntityUserdataIdentityCreateSeq" value="Inicio.6." />
                                <property name="date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss:SSS')" />
                            </log>
                        </else>
                    </filter>
                </then>
                <else>
                    <property name="fault" value="error when consulting userdata by id " />
                    <sequence key="FaultSeq" />
                </else>
            </filter>
        </then>
        <else>
            <property name="fault" value="Not found userDataId " />
            <sequence key="FaultUserSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="EntityUserdataIdentityCreateSeq" value="Fin..." />
        <property name="date" expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss:SSS')" />
    </log>
</sequence>