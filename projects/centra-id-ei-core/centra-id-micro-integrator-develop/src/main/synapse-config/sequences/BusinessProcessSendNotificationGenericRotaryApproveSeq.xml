<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessProcessSendNotificationGenericRotaryApproveSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="BusinessProcessSendNotificationGenericRotaryApproveSeq" value="Inicio.." />
    </log>
    <property name="uri.var.codigoSupervisor" expression="$ctx:data//responsibleUserName" />
    <!-- Consultar usuario supervisor -->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSimple/0/1?employeeCode={uri.var.codigoSupervisor}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="supervisor" expression="$body//*" scope="default" type="OM" />
            <property name="toAddress" expression="$ctx:supervisor//mail" />
        </then>
        <else>
            <property name="fault" value="Error get supervisor" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <!-- Consultar usuario solicitante -->
    <property name="uri.var.usernameCreation" expression="$ctx:data//usernameCreation" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSimple/0/1?username={uri.var.usernameCreation}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="solicitante" expression="$body//*" scope="default" type="OM" />
        </then>
        <else>
            <property name="fault" value="Error get solicitante" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <payloadFactory media-type="json">
        <format>
            [
                {
                    "campo":"Generado",
                    "valor":"$1"
                
                },
                {
                    "campo":"usuario",
                    "valor":"$2"
                
                },
                {
                    "campo":"tipoUsuario",
                    "valor":"$3"
                
                },
                {
                    "campo":"centroCostos",
                    "valor":"$4"
                
                },
                {
                    "campo":"responsable",
                    "valor":"$5"
                
                },
                {
                    "campo":"usuarioSolicitante",
                    "valor":"$6"
                
                },
                {
                    "campo":"fechaVigencia",
                    "valor":"$7"
                
                },
                {
                    "campo":"justificacion",
                    "valor":"$8"
                
                },
                {
                    "campo":"observacion",
                    "valor":"$9"
                
                }
            ]                      
            </format>
        <args>
            <arg evaluator="xml" expression="$ctx:currentDate" />
            <arg evaluator="xml" expression="$ctx:data//userTypeName" />
            <arg evaluator="xml" expression="$ctx:data//userSubtypeName" />
            <arg evaluator="xml" expression="$ctx:data//costCenterName" />
            <arg evaluator="xml" expression="$ctx:supervisor//employeeCompleteName" />
            <arg evaluator="xml" expression="$ctx:solicitante//employeeCompleteName" />
            <arg evaluator="xml" expression="$ctx:data//effectiveDate" />
            <arg evaluator="xml" expression="$ctx:data//justification" />
            <arg evaluator="xml" value="..." />
        </args>
    </payloadFactory>
    <log level="custom" category="DEBUG">
        <property name="BusinessProcessSendNotificationGenericRotaryApproveSeq" value="Fin.." />
    </log>
</sequence>