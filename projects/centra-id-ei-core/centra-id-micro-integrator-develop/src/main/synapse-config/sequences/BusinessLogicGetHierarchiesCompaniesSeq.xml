<?xml version="1.0" encoding="UTF-8"?>
<sequence name="BusinessLogicGetHierarchiesCompaniesSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="INFO">
        <property name="BusinessLogicGetHierarchiesCompaniesSeq" value="Inicio..." />
    </log>
    <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
    <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
    <property name="Accept" scope="transport" type="STRING" value="application/xml" />
    <property action="remove" name="Content-Type" scope="transport" />
    <property name="companyCode" expression="//companyCode/text()" />
    <property name="divisionCode" expression="//divisionCode/text()" />
    <property name="areaCode" expression="//areaCode/text()" />
    <property name="deparmentCode" expression="//deparmentCode/text()" />
    <property name="positionCode" expression="//positionCode/text()" />
    <property name="current" expression="//current/text()" />
    <script language="js">
        <![CDATA[
            var log = mc.getServiceLog();
            var companyCode = String(mc.getProperty("companyCode"));
            var divisionCode = String(mc.getProperty("divisionCode"));
            var areaCode = String(mc.getProperty("areaCode"));
            var deparmentCode = String(mc.getProperty("deparmentCode"));
            var positionCode = String(mc.getProperty("positionCode"));
            var current = String(mc.getProperty("current"));
            var select = " ";
            var whereclause = "1=1 ";
            var joinclause = "";
            var orderby = "";
            // Construyendo SELECT
            if(current=="DIV"){
                select = "DISTINCT ca.CODE,ca.NAME ";
            } else if(current=="ARE"){
                select = "DISTINCT ca2.CODE,ca2.NAME ";                
            } else if(current=="DEP"){
                select = "DISTINCT ca3.CODE,ca3.NAME ";                
            } else if(current=="CAR"){
                select = "DISTINCT ca4.CODE,ca4.NAME ";                
            }
            // Construyendo JOIN
            joinclause += "LEFT JOIN SCH_CENTRA_ID.CATALOGS ca on cs.CATALOG_ORGANIZATIONAL_STRUCTURE_ID=ca.ID AND  CS.CATALOG_TYPE_CODE='DIV' AND cs.VALID=1 ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.COMPANIES c on cs.COMPANY_ID = c.ID ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.COMPANIES_STRUCTURES cs2 on cs2.PARENT_ID=cs.ID  AND CS2.CATALOG_TYPE_CODE='ARE' AND cs2.VALID=1 ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.CATALOGS ca2 on cs2.CATALOG_ORGANIZATIONAL_STRUCTURE_ID=ca2.ID   ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.COMPANIES_STRUCTURES cs3 on cs3.PARENT_ID=cs2.ID  AND CS3.CATALOG_TYPE_CODE='DEP' AND cs3.VALID=1 ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.CATALOGS ca3 on cs3.CATALOG_ORGANIZATIONAL_STRUCTURE_ID=ca3.ID  ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.COMPANIES_STRUCTURES cs4 on cs4.PARENT_ID=cs3.ID  AND CS4.CATALOG_TYPE_CODE='CAR' AND cs4.VALID=1 ";
            joinclause += "LEFT JOIN SCH_CENTRA_ID.CATALOGS ca4 on cs4.CATALOG_ORGANIZATIONAL_STRUCTURE_ID=ca4.ID ";

            // Construyendo WHERE
            if(current=="DIV"){
                whereclause += " AND ca.code IS NOT NULL ";
            } else if(current=="ARE"){
                whereclause += " AND ca2.code IS NOT NULL ";
            } else if(current=="DEP"){
                whereclause += " AND ca3.code IS NOT NULL ";
            } else if(current=="CAR"){
                whereclause += " AND ca4.code IS NOT NULL ";
            } 
            if(companyCode!="*" && companyCode.trim().length>0 && companyCode!="") {
                whereclause += " AND c.CODE = '"+companyCode+"' ";
            }
            if(divisionCode!="*" && divisionCode.trim().length>0 && divisionCode!="") {
                whereclause += " AND ca.CODE = '"+divisionCode+"' ";
            }
            if(areaCode!="*" && areaCode.trim().length>0 && areaCode!="") {
                whereclause += " AND ca2.CODE = '"+areaCode+"' ";
            }
            if(deparmentCode!="*" && deparmentCode.trim().length>0 && deparmentCode!="") {
                whereclause += " AND ca3.CODE = '"+deparmentCode+"' ";
            }
            if(positionCode!="*" && positionCode.trim().length>0 && positionCode!="") {
                whereclause += " AND ca4.CODE = '"+positionCode+"' ";
            }
            // Construyendo ORDER BY
            if(current=="DIV"){
                orderby += " ca.CODE,ca.NAME  ";
            } else if(current=="ARE"){
                orderby += " ca2.CODE,ca2.NAME  ";
            } else if(current=="DEP"){
                orderby += " ca3.CODE,ca3.NAME  ";
            } else if(current=="CAR"){
                orderby += " ca4.CODE,ca4.NAME  ";
            }
            mc.setProperty("uri.var.whereclause",String(whereclause));
            mc.setProperty("uri.var.joinclause",String(joinclause));
            mc.setProperty("uri.var.select",String(select));
            mc.setProperty("uri.var.orderby",String(orderby));

        ]]>
    </script>
    <log level="custom" category="INFO">
        <property name="BusinessLogicGetHierarchiesCompaniesSeq" value="Inicio.2.." />
        <property name="uri.var.whereclause" expression="$ctx:uri.var.whereclause" />
        <property name="uri.var.joinclause" expression="$ctx:uri.var.joinclause" />
        <property name="uri.var.select" expression="$ctx:uri.var.select" />
        <property name="uri.var.orderby" expression="$ctx:uri.var.orderby" />
    </log>
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.dataServiceHost}/HierarchiesDSS.HTTPEndpoint/getHierarchyDynamic?select={uri.var.select}&amp;whereclause={uri.var.whereclause}&amp;orderby={uri.var.orderby}&amp;joinclause={uri.var.joinclause}" />
    </call>
    <property expression="json-eval($.Fault.faultcode)" name="faultCode" scope="default" type="STRING" />
    <filter regex="true" source="boolean(get-property('faultCode'))">
        <then>
            <sequence key="FaultSeq" />
        </then>
        <else>
            <xslt key="gov:/centra-id/xslt/dssFilter.xsl" />
            <property name="messageType" scope="axis2" type="STRING" value="application/json" />
            <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
        </else>
    </filter>
    <property name="messageType" value="application/json" scope="axis2" type="STRING" />
    <property name="Access-Control-Allow-Methods" value="GET,PUT,POST,DELETE,PATCH,OPTIONS" scope="transport" type="STRING" />
    <property name="Access-Control-Allow-Headers" value="Authorization,Access-Control-Allow-Origin,Content-Type" scope="transport" type="STRING" />
    <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
    <log level="custom" category="INFO">
        <property name="BusinessLogicGetHierarchiesCompaniesSeq" value="Fin..." />
    </log>
</sequence>