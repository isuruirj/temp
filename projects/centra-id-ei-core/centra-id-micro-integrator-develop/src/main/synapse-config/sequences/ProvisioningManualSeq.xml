<?xml version="1.0" encoding="UTF-8"?>
<sequence name="ProvisioningManualSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="ProvisioningManualSeq.*" value="Inicio.." />
        <property name="X-Forwarded-For" expression="$ctx:X-Forwarded-For" />
        <property name="UserName" expression="$ctx:UserName" />
        <property name="operationProvisioningId" expression="$ctx:operationProvisioningId" />
    </log>
    <enrich>
        <source clone="false" type="body" />
        <target action="replace" type="property" property="payloadManual" />
    </enrich>
    <!-- Recupera el perfil global -->
    <property name="uri.var.globalProfileId" expression="//taskProvisioning[1]/operationProvisioning[1]/transactionalIdentity[1]/globalProfileId[1]/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/application/GlobalProfile?id={uri.var.globalProfileId}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="globalProfile" expression="$body/*" scope="default" type="OM" />
        </then>
    </filter>
    <enrich>
        <source clone="false" type="property" property="payloadManual" />
        <target type="body" />
    </enrich>
    <xslt key="gov:/centra-id/xslt/ticketManual.xsl">
        <property name="environment" expression="get-property('ENVIRONMENT')" />
        <property name="globalProfile" expression="get-property('globalProfile')//globalProfileList/globalProfile/name" />
    </xslt>
    <property name="target.endpoint" value="ProvisioningEP" />
    <header name="Action" value="http://tempuri.org/crearRequerimientos" />
    <property name="SOAPAction" scope="transport" value="http://tempuri.org/crearRequerimientos" />
    <store messageStore="ProvisioningStore" />
    <!-- actualizar xml -->
    <property name="input" expression="$body//*" scope="default" />
    <property name="messageType" scope="axis2" type="STRING" value="application/xml" />
    <property name="Accept" scope="transport" type="STRING" value="application/xml" />
    <payloadFactory media-type="xml">
        <format>
            <ci:update_all_query_operation xmlns:ci="centra-id.com">
                <ci:table>SCH_CENTRA_ID.TAKS_PROVISIONING</ci:table>
                <ci:set>DATA_INPUT_QUEUE='$1'</ci:set>
                <ci:where>VALID=1 AND OPERATION_PROVISIONING_ID=$2 AND TYPE=0</ci:where>
            </ci:update_all_query_operation>
        </format>
        <args>
            <arg evaluator="xml" expression="base64Encode($ctx:input)" />
            <arg evaluator="xml" expression="$ctx:operationProvisioningId" />
        </args>
    </payloadFactory>
    <call>
        <endpoint template="HTTPEndpointPutTemplate" uri="{uri.var.dataServiceHost}/UsersDSS.HTTPEndpoint/updateAll" />
    </call>
    <log level="custom" category="DEBUG">
        <property name="ProvisioningManualSeq.*" value="Fin.." />
        <property name="X-Forwarded-For" expression="$ctx:X-Forwarded-For" />
        <property name="UserName" expression="$ctx:UserName" />
    </log>
</sequence>