<?xml version="1.0" encoding="UTF-8"?>
<sequence name="CrearClaimSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="*****CrearClaimSeq" value="Inicio..." />
    </log>
    <header name="Content-Type" scope="transport" value="application/xml" />
    <!-- Eliminar header Accept: application/json -->
    <property action="remove" name="Accept" scope="transport" />
    <!-- Definir propiedades correspondientes -->
    <property expression="synapse:get-property('IS_SERVER_USER')" name="IS_SERVER_USER_DATO" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd" xmlns:soapenv="http://www.w3.org/2003/05/soap-envelope" />
    <property expression="synapse:get-property('IS_SERVER_PASSWORD')" name="IS_SERVER_PASSWORD_DATO" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd" xmlns:soapenv="http://www.w3.org/2003/05/soap-envelope" />
    <property expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:IS_SERVER_USER_DATO,':',$ctx:IS_SERVER_PASSWORD_DATO)))" name="Authorization" scope="transport" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" />
    <!-- Cargar variables de entorno -->
    <sequence key="MassiveProcessUsersVariablesLoadSeq" />
    <!-- Iterar claims recibidos -->
    <iterate expression="//claims" preservePayload="true" sequential="true">
        <target>
            <sequence>
                <sequence key="CrearClaimIndividualSeq" />
            </sequence>
        </target>
    </iterate>
    <property name="data" scope="default">
        <data />
    </property>
    <aggregate>
        <completeCondition>
            <messageCount min="-1" max="-1" />
        </completeCondition>
        <onComplete expression="$body/*[1]" enclosingElementProperty="data">
            <log level="custom" category="DEBUG">
                <property name="agregado" value="ok" />
            </log>
        </onComplete>
    </aggregate>
    <log level="custom" category="DEBUG">
        <property name="*****CrearClaimSeq" value="Fin..." />
    </log>
    <respond />
</sequence>