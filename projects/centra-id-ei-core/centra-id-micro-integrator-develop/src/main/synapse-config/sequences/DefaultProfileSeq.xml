<?xml version="1.0" encoding="UTF-8"?>
<sequence name="DefaultProfileSeq" onError="FaultMassiveProcessUsersSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <!-- VALORES DEL EMPLEADO -->
        <property name="DefaultProfileSeq" value="Inicio..." />
        <property name="uri.var.massiveProcessId" expression="get-property('uri.var.massiveProcessId')" />
        <property name="uri.var.company" expression="get-property('uri.var.company')" />
        <property name="uri.var.division" expression="get-property('uri.var.division')" />
        <property name="uri.var.area" expression="get-property('uri.var.area')" />
        <property name="uri.var.department" expression="get-property('uri.var.department')" />
        <property name="uri.var.position" expression="get-property('uri.var.position')" />
        <property name="result" expression="get-property('result')" />
        <property name="profile" expression="get-property('profile')" />
        <property name="case" expression="get-property('case')" />
    </log>
    <filter regex="V" source="get-property('case')">
        <then>
            <filter regex="true" source="boolean(get-property('profile'))">
                <then>
                    <!-- selecciona perfil -->
                    <property action="set" name="profileSelect" expression="get-property('profile')" />
                </then>
                <else>
                    <!-- error duplicado -->
                    <property action="set" name="profileDuplicate" value="Y" />
                </else>
            </filter>
        </then>
        <else>
            <!-- DETERMINAR CASO ACTUAL-->
            <filter regex="false" source="boolean(get-property('case'))">
                <then>
                    <!-- CASO COMPANIA -->
                    <property action="set" name="case" value="C" />
                    <property action="set" name="uri.var.companyDefault" expression="get-property('uri.var.company')" />
                    <property action="set" name="uri.var.divisionDefault" value="" />
                    <property action="set" name="uri.var.areaDefault" value="" />
                    <property action="set" name="uri.var.departmentDefault" value="" />
                    <property action="set" name="uri.var.positionDefault" value="" />
                </then>
                <else>
                    <switch source="get-property('case')">
                        <case regex="C">
                            <!-- CASO CARGO -->
                            <property action="set" name="case" value="P" />
                            <switch source="get-property('result')">
                                <case regex="1">
                                    <call>
                                        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/Catalog/0/1?name={uri.var.position}&amp;catalogType.code=CAR" />
                                    </call>
                                    <property action="set" name="uri.var.positionDefault" expression="//catalog/code" />
                                </case>
                                <case regex="-1">
                                    <property action="set" name="profileNoExist" value="Y" />
                                </case>
                            </switch>
                        </case>
                        <case regex="P">
                            <!-- CASO DEPARTAMENTO -->
                            <property action="set" name="case" value="D" />
                            <switch source="get-property('result')">
                                <case regex="1">
                                    <property action="set" name="uri.var.departmentDefault" expression="get-property('uri.var.department')" />
                                </case>
                                <case regex="-1">
                                    <property action="set" name="profileNoExist" value="Y" />
                                </case>
                            </switch>
                        </case>
                        <case regex="D">
                            <!-- CASO AREA -->
                            <property action="set" name="case" value="A" />
                            <switch source="get-property('result')">
                                <case regex="1">
                                    <property action="set" name="uri.var.areaDefault" expression="get-property('uri.var.area')" />
                                </case>
                                <case regex="-1">
                                    <property action="set" name="profileNoExist" value="Y" />
                                </case>
                            </switch>
                        </case>
                        <case regex="A">
                            <!-- CASO DIVISION -->
                            <property action="set" name="case" value="V" />
                            <switch source="get-property('result')">
                                <case regex="1">
                                    <property action="set" name="uri.var.divisionDefault" expression="get-property('uri.var.division')" />
                                </case>
                                <case regex="-1">
                                    <property action="set" name="profileNoExist" value="Y" />
                                </case>
                            </switch>
                        </case>
                    </switch>
                </else>
            </filter>
        </else>
    </filter>
    <filter regex="true" source="boolean(get-property('profileSelect')) or boolean(get-property('profileDuplicate')) or boolean(get-property('profileNoExist'))">
        <then>
            <filter regex="true" source="boolean(get-property('profileSelect'))">
                <then>
                    <!-- Perfil seleccionado -->
                </then>
                <else>
                    <filter regex="true" source="boolean(get-property('profileDuplicate'))">
                        <then>
                            <!-- Perfil duplicado -->
                        </then>
                        <else>
                            <!-- Perfil no existe -->
                        </else>
                    </filter>
                </else>
            </filter>
        </then>
        <else>
            <sequence key="DefaultProfileCompareSeq" />
            <filter regex="-1" source="get-property('result')">
                <then>
                    <switch source="get-property('case')">
                        <case regex="C">
                            <property action="set" name="uri.var.companyDefault" value="ANY" />
                        </case>
                        <case regex="P">
                            <property action="set" name="uri.var.positionDefault" value="ANY" />
                        </case>
                        <case regex="D">
                            <property action="set" name="uri.var.departmentDefault" value="ANY" />
                        </case>
                        <case regex="A">
                            <property action="set" name="uri.var.areaDefault" value="ANY" />
                        </case>
                    </switch>
                    <sequence key="DefaultProfileCompareSeq" />
                </then>
            </filter>
            <sequence key="DefaultProfileSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="DefaultProfileSeq" value="Fin..." />
    </log>
</sequence>