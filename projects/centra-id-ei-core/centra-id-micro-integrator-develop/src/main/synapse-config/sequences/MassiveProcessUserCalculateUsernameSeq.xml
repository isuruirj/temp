<?xml version="1.0" encoding="UTF-8"?>
<sequence name="MassiveProcessUserCalculateUsernameSeq" onError="FaultMassiveProcessUsersSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:cen="centra-id.com">
	<log level="custom" category="DEBUG">
		<property name="MassiveProcessUserCalculateUsernameSeq" value="Inicio..." />
	</log>
	<property expression="get-property('employeeData')//cen:apellidosEmpleado" name="apellidos" scope="default" type="STRING" />
	<property expression="get-property('employeeData')//cen:nombresEmpleado" name="nombres" scope="default" type="STRING" />
	<script language="js">
		<![CDATA[
		var apellidos = mc.getProperty("apellidos");
		var nombres = mc.getProperty("nombres");

		// generar username 1
		var username1 = nombres.toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase() ;
		username1 = username1.toString().substr(0,8);
        username1 = username1.split(" ").join("");		
		mc.setProperty('uri.var.username1',username1);

		// generar username 2
		var username2 = nombres.toString().substr(0,1).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()  ;
		username2 = username2.toString().substr(0,8);
        username2 = username2.split(" ").join("");		
		mc.setProperty('uri.var.username2',username2);
		
		// generar username 3
		var username3 = nombres.toString().substr(0,1).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()
		+apellidos.split(" ")[1].toString().substr(0,1).toLowerCase()  ;
		username3 = username3.toString().substr(0,8);
        username3 = username3.split(" ").join("");		
		mc.setProperty('uri.var.username3',username3);
		
		// generar username 4
		var username4 = nombres.toString().substr(0,2).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()
		+apellidos.split(" ")[1].toString().substr(0,1).toLowerCase()  ;
		username4 = username4.toString().substr(0,8);
        username4 = username4.split(" ").join("");		
		mc.setProperty('uri.var.username4',username4);		
		
		// generar username 5
		var username5 = nombres.toString().substr(0,3).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()
		+apellidos.split(" ")[1].toString().substr(0,1).toLowerCase()  ;
		username5 = username5.toString().substr(0,8);
        username5 = username5.split(" ").join("");		
		mc.setProperty('uri.var.username5',username5);
		
		// generar username 6
		var username6 = nombres.toString().substr(0,4).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()
		+apellidos.split(" ")[1].toString().substr(0,1).toLowerCase()  ;
		username6 = username6.toString().substr(0,8);
        username6 = username6.split(" ").join("");		
		mc.setProperty('uri.var.username6',username6);

		
		// generar username 7
		var username7 = nombres.toString().substr(0,5).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()
		+apellidos.split(" ")[1].toString().substr(0,1).toLowerCase()  ;
		username7 = username7.toString().substr(0,8);
        username7 = username7.split(" ").join("");		
		mc.setProperty('uri.var.username7',username7);		
		
		// generar username 8
		var username8 = nombres.toString().substr(0,6).toLowerCase()+nombres.split(" ")[1].toString().substr(0,1).toLowerCase()+apellidos.split(" ")[0].toLowerCase()
		+apellidos.split(" ")[1].toString().substr(0,1).toLowerCase()  ;
		username8 = username8.toString().substr(0,8);
		username8 = username8.split(" ").join("");
		mc.setProperty('uri.var.username8',username8);]]>
	</script>
	<property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
	<property action="remove" name="Content-Type" scope="transport" />
	<call>
		<endpoint name="UsersDSS.Endpoint" template="HTTPEndpointGetTemplate" uri="{uri.var.dataServiceHost}/UsersDSS.HTTPEndpoint/getUserByUsername?username1={uri.var.username1}&amp;username2={uri.var.username2}&amp;username3={uri.var.username3}&amp;username4={uri.var.username4}&amp;username5={uri.var.username5}&amp;username6={uri.var.username6}&amp;username7={uri.var.username7}&amp;username8={uri.var.username8}" />
	</call>
	<property expression="//cen:Users/cen:User[1]/cen:username" name="username" scope="default" type="STRING" />
	<!-- calcular password -->
	<script language="js">
		<![CDATA[
			var log = mc.getServiceLog();       
			function passwordGenerator( len ) {
				var length = (len)?(len):(10);
				var string = "abcdefghijklmnopqrstuvwxyz"; //to upper 
				var numeric = '0123456789';
				var punctuation = '!@#$%&';
				var password = "";
				var character = "";
				var crunch = true;
				while( password.length<length ) {
					entity1 = Math.ceil(string.length * Math.random()*Math.random());
					entity2 = Math.ceil(numeric.length * Math.random()*Math.random());
					entity3 = Math.ceil(punctuation.length * Math.random()*Math.random());
					hold = string.charAt( entity1 );
					hold = (password.length%2==0)?(hold.toUpperCase()):(hold);
					character += hold;
					character += numeric.charAt( entity2 );
					character += punctuation.charAt( entity3 );
					password = character;
				}
				password=password.split('').sort(function(){return 0.5-Math.random()}).join('');
				return password.substr(0,len);
			}
			var password = passwordGenerator(12);            
			log.debug(password);
			mc.setProperty('password',password);
	    ]]>
	</script>
	<log level="custom" category="DEBUG">
		<property name="MassiveProcessUserCalculateUsernameSeq" value="Fin..." />
		<property expression="get-property('username')" name="username" />
		<property expression="get-property('password')" name="password" />
	</log>
</sequence>