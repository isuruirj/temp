<?xml version="1.0" encoding="UTF-8"?>
<sequence name="WSO2AM--Ext--In" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom">
        <property name="TRACE" value="Centra ID Global Mediation Extension"/>
    </log>
    <property expression="$ctx:API_NAME" name="ApiName" scope="transport" type="STRING"/>
    <filter regex=".*" source="get-property('transport','X-Forwarded-For')">
        <then>
            <property expression="fn:concat(get-property('transport','X-Forwarded-For'), ', ')" name="coming-X-Forwarded-For" scope="axis2" type="STRING"/>
            <property expression="get-property('axis2','REMOTE_ADDR')" name="clientIP" scope="default" type="STRING"/>
            <property expression="fn:concat(get-property('axis2','coming-X-Forwarded-For'), $ctx:clientIP)" name="X-Forwarded-For" scope="transport" type="STRING"/>
        </then>
        <else>
            <property expression="get-property('axis2','REMOTE_ADDR')" name="X-Forwarded-For" scope="transport" type="STRING"/>
        </else>
    </filter>
    <property name="UserName" expression="$ctx:api.ut.userName" />
    <filter xpath="boolean($ctx:UserName)" regex="true">
    	<then>
    		<filter xpath="fn:contains($ctx:UserName, '/')" regex="true">
		    	<then>
		    		<property name="UserName" expression="fn:substring-after($ctx:UserName, '/')" />
		    	</then>
		    	<else/>
		    </filter>
    		<filter xpath="fn:contains($ctx:UserName, '@')" regex="true">
		    	<then>
			    	<property name="UserName" expression="fn:substring-before($ctx:UserName, '@')" />
		    	</then>
		    	<else>
		    	</else>
		    </filter>
    	</then>
    	<else>
    		<property name="UserName" value="auto" />
    	</else>
    </filter>
    <property expression="$ctx:UserName" name="UserName" scope="transport" type="STRING"/>
    <log level="custom">
        <property expression="$trp:X-Forwarded-For" name="X-Forwarded-For"/>
        <property expression="$trp:UserName" name="UserName"/>
        <property expression="$trp:ApiName" name="ApiName"/>
    </log>
</sequence>