<?xml version="1.0" encoding="UTF-8"?>
<sequence name="CheckOverdueTasksSeq" xmlns="http://ws.apache.org/ns/synapse" onError="FaultSeq">
    <log level="custom" category="INFO">
        <property name="CheckOverdueTasksSeq" value="Inicio...." />
    </log>
    <sequence key="MassiveProcessUsersVariablesLoadSeq" />
    <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/GlobalParameter?code=MAJEPRPE" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <!-- Calcula fecha de vencimiento (fecha actual - dias duracion del tramite) -->
            <property name="days" expression="//globalParameter/valueNumber" scope="default" type="STRING" />
            <script language="js">
                <![CDATA[
                    var log = mc.getServiceLog();        
                    //log.info("Logging inside Script Mediator");
                    var  simpleDateFormat = Packages.java.text.SimpleDateFormat;
                    var fomatter = new simpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'+00:00'");
                    var date = Packages.java.util.Date;
                    var currentDate = fomatter.format(new date());
                    //log.info("Current date : " + currentDate );
                    
                    var calendar = Packages.java.util.Calendar.getInstance();
                    calendar.setTime(fomatter.parse(currentDate));
                    var daysToAdd = mc.getProperty("days");
                    calendar.add(Packages.java.util.Calendar.DATE,(-1)* daysToAdd);
                    var destDate = fomatter.format(calendar.getTime()); 
                    //log.info("Destination date : " + destDate );
                    mc.setProperty("uri.var.date", destDate);
                ]]>
            </script>
            <log level="custom" category="INFO">
                <property name="CheckOverdueTasksSeq" expression="$ctx:uri.var.date" />
            </log>
            <property expression="synapse:get-property('BPS_SERVER_USER')" name="BPS_SERVER_USER_DATO" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd" />
            <property expression="synapse:get-property('BPS_SERVER_PASSWORD')" name="BPS_SERVER_PASSWORD_DATO" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" xmlns:ns2="http://org.apache.synapse/xsd" />
            <property expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:BPS_SERVER_USER_DATO,':',$ctx:BPS_SERVER_PASSWORD_DATO)))" name="Authorization" scope="transport" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" />
            <call>
                <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.bussinesProcessServiceHost}/bpmn/runtime/tasks?createdAfter={uri.var.date}" />
            </call>
            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <filter regex="false" source="//total = 0">
                        <then>
                            <iterate expression="//data">
                                <target>
                                    <sequence>
                                        <property name="uri.var.taskId" expression="//id/text()" />
                                        <!-- cancelar la tarea -->
                                        <payloadFactory media-type="json">
                                            <format>
                                                {
                                                    "action": "complete",
                                                    "variables": [
                                                        {
                                                            "name": "accionId",
                                                            "value" : "canceladoId"
                                                        }
                                                    ]
                                                }
                                            </format>
                                            <args />
                                        </payloadFactory>
                                        <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
                                        <property expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:BPS_SERVER_USER_DATO,':',$ctx:BPS_SERVER_PASSWORD_DATO)))" name="Authorization" scope="transport" type="STRING" xmlns:ns="http://org.apache.synapse/xsd" />
                                        <call>
                                            <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.bussinesProcessServiceHost}/bpmn/runtime/tasks/{uri.var.taskId}" />
                                        </call>
                                        <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                                            <then>
                                                <payloadFactory media-type="json">
                                                    <format>
                                                        {
                                                            "result":  {
                                                                "code" : -1,
                                                                "message" : "Failed operation !"
                                                            }
                                                        }
                                                    </format>
                                                    <args />
                                                </payloadFactory>
                                            </then>
                                            <else>
                                                <property name="fault" scope="default" type="STRING" value="error when attending the task " />
                                                <sequence key="FaultSeq" />
                                            </else>
                                        </filter>
                                    </sequence>
                                </target>
                            </iterate>
                        </then>
                        <else>
                            <log level="custom" category="INFO">
                                <property name="CheckOverdueTasksSeq" value="No existen tareas que caduquen" />
                            </log>
                        </else>
                    </filter>
                </then>
                <else>
                    <property name="fault" value="Error get Task" />
                    <sequence key="FaultSeq" />
                </else>
            </filter>
        </then>
        <else>
            <property name="fault" value="Error get GlobalParameter" />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <property name="messageType" scope="axis2" type="STRING" value="application/json" />
    <property name="HTTP_SC" scope="axis2" type="STRING" value="200" />
    <log level="custom" category="INFO">
        <property name="CheckOverdueTasksSeq" value="Fin...." />
    </log>
</sequence>