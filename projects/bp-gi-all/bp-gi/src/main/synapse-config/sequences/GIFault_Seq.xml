<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GIFault_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIFault_Seq --------------------"/>
        <property expression="get-property('cgi-error-codigo')" name="cgi-error-codigo"/>
        <property expression="get-property('ERROR_CODE')" name="ERROR_CODE"/>
        <property expression="get-property('ERROR_MESSAGE')" name="ERROR_MESSAGE"/>
    </log>
    <filter xpath="$body/*">
        <then>
            <log description="msg" level="custom">
                <property name="msg" value="GIFault_Seq body OK  ====="/>
            </log>
            <property description="MENSAJE_RESPUESTA" expression="$env" name="MENSAJE_RESPUESTA" scope="default" type="STRING"/>
            <property description="MENSAJE_RESPUESTA_VALORES" expression="$env" name="MENSAJE_RESPUESTA_VALORES" scope="default" type="OM"/>
        </then>
        <else>
            <log description="msg" level="custom">
                <property name="msg" value="GIFault_Seq body EMPTY  ====="/>
            </log>
            <property description="MENSAJE_RESPUESTA" expression="get-property('ERROR_MESSAGE')" name="MENSAJE_RESPUESTA" scope="default" type="STRING"/>
            <enrich description="target:MENSAJE_RESPUESTA_EMPTY">
                <source clone="true" type="inline">
                    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                        <soapenv:Body>
                            <Mensaje xmlns="http://tempuri.org/"/>
                        </soapenv:Body>
                    </soapenv:Envelope>
                </source>
                <target property="MENSAJE_RESPUESTA_EMPTY" type="property"/>
            </enrich>
            <property description="MENSAJE_RESPUESTA_VALORES" expression="get-property('MENSAJE_RESPUESTA_EMPTY')" name="MENSAJE_RESPUESTA_VALORES" scope="default" type="OM"/>
            <enrich>
                <source clone="true" property="ERROR_MESSAGE" type="property"/>
                <target xpath="$ctx:MENSAJE_RESPUESTA_VALORES//*[local-name()='Mensaje']"/>
            </enrich>
        </else>
    </filter>
    <switch source="get-property('ESTADO')">
        <case regex="R">
            <property description="CONFIG" expression="get-property('registry','gov:/pichincha/gidentidades.xml')" name="CONFIG" scope="default" type="OM"/>
            <property description="MAX_REINTENTOS" expression="$ctx:CONFIG/NroReintentos/text()" name="MAX_REINTENTOS" scope="default" type="STRING"/>
            <filter xpath="fn:round($ctx:REINTENTO) &lt; fn:round($ctx:MAX_REINTENTOS)">
                <then>
                    <log description="R" level="custom">
                        <property name="msg" value="GIFault_Seq  Case R ==== Reintento"/>
                    </log>
                    <property description="Calculate REINTENTO" expression="string(number($ctx:REINTENTO)+1)" name="INT_REINTENTO" scope="default" type="STRING"/>
                    <sequence key="GITareas_Retry_Seq"/>
                    <log description="seq" level="custom">
                        <property name="seq" value="-------------------- Back to GIFault_Seq --------------------"/>
                    </log>
                    <payloadFactory description="Estado R" media-type="xml">
                        <format key="gov:/pichincha/Update_GIdentidad.xml"/>
                        <args>
                            <arg evaluator="xml" expression="get-property('GUID')"/>
                            <arg value="1"/>
                            <arg value="R"/>
                            <arg evaluator="xml" expression="get-property('REQUEST_ORIGIN')"/>
                            <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_PETICION'))"/>
                            <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_RESPUESTA'))"/>
                            <arg evaluator="xml" expression="get-property('SOAP_ACTION_REQUEST')"/>
                            <arg evaluator="xml" expression="get-property('INT_REINTENTO')"/>
                            <arg evaluator="xml" expression="$axis2:HTTP_SC"/>
                            <arg evaluator="xml" expression="get-property('MENSAJE_PETICION_VALORES')"/>
                            <arg evaluator="xml" expression="get-property('MENSAJE_RESPUESTA_VALORES')"/>
                        </args>
                    </payloadFactory>
                    <sequence key="GIUpdate_Reproceso_Seq"/>
                </then>
                <else>
                    <log description="F" level="custom">
                        <property name="msg" value="GIFault_Seq  Case F ==== Finalized retrial"/>
                    </log>
                    <payloadFactory description="Estado F" media-type="xml">
                        <format key="gov:/pichincha/Update_GIdentidad.xml"/>
                        <args>
                            <arg evaluator="xml" expression="get-property('GUID')"/>
                            <arg value="1"/>
                            <arg value="F"/>
                            <arg evaluator="xml" expression="get-property('REQUEST_ORIGIN')"/>
                            <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_PETICION'))"/>
                            <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_RESPUESTA'))"/>
                            <arg evaluator="xml" expression="get-property('SOAP_ACTION_REQUEST')"/>
                            <arg value="0"/>
                            <arg evaluator="xml" expression="$axis2:HTTP_SC"/>
                            <arg evaluator="xml" expression="get-property('MENSAJE_PETICION_VALORES')"/>
                            <arg evaluator="xml" expression="get-property('MENSAJE_RESPUESTA_VALORES')"/>
                        </args>
                    </payloadFactory>
                    <sequence key="GIUpdate_Reproceso_Seq"/>
                    <sequence key="GIConsulta_Genera_Ticket_Seq"/>
                </else>
            </filter>
        </case>
        <case regex="O">
            <log description="O" level="custom">
                <property name="msg" value="GIFault_Seq  Case 0 ==== Nuevo Origen"/>
            </log>
            <clone continueParent="true">
                <target>
                    <sequence>
                        <sequence key="GITareas_Retry_Seq"/>
                        <payloadFactory description="Estado R" media-type="xml">
                            <format key="gov:/pichincha/Insert_GIdentidades.xml"/>
                            <args>
                                <arg evaluator="xml" expression="get-property('GUID')"/>
                                <arg evaluator="xml" expression="get-property(&quot;SYSTEM_DATE&quot;, &quot;yyyy-MM-dd'T'HH:mm:ss.SSSXXX&quot;)"/>
                                <arg value="1"/>
                                <arg value="R"/>
                                <arg evaluator="xml" expression="get-property('REQUEST_ORIGIN')"/>
                                <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_PETICION'))"/>
                                <arg evaluator="xml" expression="base64Encode(get-property('MENSAJE_RESPUESTA'))"/>
                                <arg evaluator="xml" expression="get-property('SOAP_ACTION_REQUEST')"/>
                                <arg evaluator="xml" expression="$axis2:HTTP_SC"/>
                                <arg evaluator="xml" expression="get-property('MENSAJE_PETICION_VALORES')"/>
                                <arg evaluator="xml" expression="get-property('MENSAJE_RESPUESTA_VALORES')"/>
                            </args>
                        </payloadFactory>
                        <header name="SOAPAction" scope="transport" value="urn:Insert_GIdentidad"/>
                        <log description="Payload" level="custom">
                            <property expression="$body" name="Dss Insert_GIdentidad Operation ___ Body ______"/>
                        </log>
                        <call>
                            <endpoint key="GIDss_GIdentidades_EP"/>
                        </call>
                        <drop/>
                    </sequence>
                </target>
            </clone>
        </case>
        <default/>
    </switch>
    <sequence key="GIHandle_Runtime_Error_Seq"/>
</sequence>
