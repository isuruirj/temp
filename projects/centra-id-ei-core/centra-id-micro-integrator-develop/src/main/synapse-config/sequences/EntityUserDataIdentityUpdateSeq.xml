<?xml version="1.0" encoding="UTF-8"?>
<sequence name="EntityUserDataIdentityUpdateSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:ns="http://org.apache.axis2/xsd" xmlns:ax2764="http://common.mgt.user.carbon.wso2.org/xsd">
    <log level="custom" category="DEBUG">
        <property name="EntityUserDataIdentityUpdateSeq" value="Inicio..." />
        <property name="userdataId" expression="get-property('userdataId')" />
    </log>
    <property name="uri.var.userdataId" expression="$ctx:userdataId" />
    <!-- recuperar los datos del userdata -->
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserDataSearch/{uri.var.userdataId}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <filter regex="true" source="boolean(//identificacionSupervisor/text())">
                <then>
                    <property name="identificacionSupervisor" expression="//identificacionSupervisor/text()" />
                    <property name="nombreSupervisor" expression="//nombreSupervisor/text()" />
                </then>
            </filter>
            <filter regex="true" source="boolean(//identificacionContraparte/text())">
                <then>
                    <property name="identificacionSupervisor" expression="//identificacionContraparte/text()" />
                    <property name="nombreSupervisor" expression="//nombreContraparte/text()" />
                </then>
            </filter>
            <filter regex="true" source="boolean(//identificacionResponsable/text())">
                <then>
                    <property name="identificacionSupervisor" expression="//identificacionResponsable/text()" />
                    <property name="nombreSupervisor" expression="//nombreResponsable/text()" />
                </then>
            </filter>
            <!-- Actualizar Usuario -->
            <payloadFactory media-type="xml">
                <format>
                    <ser:setUserClaimValues xmlns:ser="http://service.ws.um.carbon.wso2.org" xmlns:xsd="http://common.mgt.user.carbon.wso2.org/xsd">
                        <ser:userName>$34</ser:userName>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoTrabajador</xsd:claimURI>
                            <xsd:value>$1</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/apellidosEmpleado</xsd:claimURI>
                            <xsd:value>$2</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombresEmpleado</xsd:claimURI>
                            <xsd:value>$3</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/identificacion</xsd:claimURI>
                            <xsd:value>$4</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/identificacionSupervisor</xsd:claimURI>
                            <xsd:value>$5</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreSupervisor</xsd:claimURI>
                            <xsd:value>$6</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoCompania</xsd:claimURI>
                            <xsd:value>$7</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreCompania</xsd:claimURI>
                            <xsd:value>$8</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoAgrupacion</xsd:claimURI>
                            <xsd:value>$9</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreAgrupacion</xsd:claimURI>
                            <xsd:value>$10</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoDivision</xsd:claimURI>
                            <xsd:value>$11</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreDivision</xsd:claimURI>
                            <xsd:value>$12</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoDepartamento</xsd:claimURI>
                            <xsd:value>$13</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreDepartamento</xsd:claimURI>
                            <xsd:value>$14</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoArea</xsd:claimURI>
                            <xsd:value>$15</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreArea</xsd:claimURI>
                            <xsd:value>$16</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoCentroCosto</xsd:claimURI>
                            <xsd:value>$17</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreCentroCosto</xsd:claimURI>
                            <xsd:value>$18</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreLocalidad</xsd:claimURI>
                            <xsd:value>$19</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreCargo</xsd:claimURI>
                            <xsd:value>$20</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoNivelJerarquico</xsd:claimURI>
                            <xsd:value>$21</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombreNivelJerarquico</xsd:claimURI>
                            <xsd:value>$22</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/numeroCuentaDeposito</xsd:claimURI>
                            <xsd:value>$23</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/fechaEntrada</xsd:claimURI>
                            <xsd:value>$24</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/fechaSalida</xsd:claimURI>
                            <xsd:value>$25</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/celular</xsd:claimURI>
                            <xsd:value>$26</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/codigoEmpleado</xsd:claimURI>
                            <xsd:value>$27</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/tipoUsuario</xsd:claimURI>
                            <xsd:value>$28</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/subTipo</xsd:claimURI>
                            <xsd:value>$29</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/globalProfileCode</xsd:claimURI>
                            <xsd:value>$30</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/globalProfileId</xsd:claimURI>
                            <xsd:value>$31</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/globalProfileName</xsd:claimURI>
                            <xsd:value>$32</xsd:value>
                        </ser:claims>
                        <ser:claims>
                            <xsd:claimURI>http://wso2.org/claims/nombres</xsd:claimURI>
                            <xsd:value>$33</xsd:value>
                        </ser:claims>
                        <ser:profileName>default</ser:profileName>
                    </ser:setUserClaimValues>
                </format>
                <args>
                    <arg evaluator="xml" expression="//codigoTrabajador/text()" />
                    <arg evaluator="xml" expression="//apellidosEmpleado/text()" />
                    <arg evaluator="xml" expression="//nombresEmpleado/text()" />
                    <arg evaluator="xml" expression="//identificacion/text()" />
                    <arg evaluator="xml" expression="$ctx:identificacionSupervisor" />
                    <arg evaluator="xml" expression="$ctx:nombreSupervisor" />
                    <arg evaluator="xml" expression="//codigoCompania/text()" />
                    <arg evaluator="xml" expression="//nombreCompania/text()" />
                    <arg evaluator="xml" expression="//codigoAgrupacion/text()" />
                    <arg evaluator="xml" expression="//codigoAgrupacion/text()" />
                    <arg evaluator="xml" expression="//codigoDivision/text()" />
                    <arg evaluator="xml" expression="//nombreDivision/text()" />
                    <arg evaluator="xml" expression="//codigoDepartamento/text()" />
                    <arg evaluator="xml" expression="//nombreDepartamento/text()" />
                    <arg evaluator="xml" expression="//codigoArea/text()" />
                    <arg evaluator="xml" expression="//nombreArea/text()" />
                    <arg evaluator="xml" expression="//codigoCentroCosto/text()" />
                    <arg evaluator="xml" expression="//nombreCentroCosto/text()" />
                    <arg evaluator="xml" expression="//nombrelocalidad/text()" />
                    <arg evaluator="xml" expression="//nombreCargo/text()" />
                    <arg evaluator="xml" expression="//codigoNivelJerarquico/text()" />
                    <arg evaluator="xml" expression="//codigoNivelJerarquico/text()" />
                    <arg evaluator="xml" expression="//numeroCuentaDeposito/text()" />
                    <arg evaluator="xml" expression="//fechaIngreso/text()" />
                    <arg evaluator="xml" expression="//fechaSalida/text()" />
                    <arg evaluator="xml" expression="//celular/text()" />
                    <arg evaluator="xml" expression="//codigoEmpleado/text()" />
                    <arg evaluator="xml" expression="//tipousuario/code/text()" />
                    <arg evaluator="xml" expression="//subtipo/code/text()" />
                    <arg evaluator="xml" expression="//codigoPerfilGlobal/text()" />
                    <arg evaluator="xml" expression="//idPerfilGlobal/text()" />
                    <arg evaluator="xml" expression="//nombrePerfilGlobal/text()" />
                    <arg evaluator="xml" expression="fn:concat(//apellidosEmpleado/text(),' ',//nombresEmpleado/text())" />
                    <arg evaluator="xml" expression="//username/text()" />
                </args>
            </payloadFactory>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
            <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="IS_SERVER_USER_DATO" expression="synapse:get-property('IS_SERVER_USER')" scope="default" />
            <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="IS_SERVER_PASSWORD_DATO" expression="synapse:get-property('IS_SERVER_PASSWORD')" scope="default" />
            <property xmlns:ns="http://org.apache.synapse/xsd" name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:IS_SERVER_USER_DATO,':',$ctx:IS_SERVER_PASSWORD_DATO)))" scope="transport" />
            <property name="service_ep" expression="fn:concat(get-property('uri.var.identityServerHost'),'/services' ,'/RemoteUserStoreManagerService')" />
            <header name="To" expression="get-property('service_ep')" />
            <property name="Accept" scope="transport" value="application/xml" />
            <call>
                <endpoint>
                    <default />
                </endpoint>
            </call>
            <property name="fault" expression="//ns:UserStoreException" />
            <property name="fault2" expression="//faultstring" />
            <log level="custom" separator="**3**">
                <property name="fault" expression="get-property('fault')" />
                <property name="fault2" expression="get-property('fault2')" />
            </log>
            <filter regex="true" source="boolean(get-property('fault')) or boolean(get-property('fault2'))">
                <then>
                    <property name="fault" expression="fn:concat(get-property('fault'),':',get-property('fault2'))" />
                    <sequence key="FaultSeq" />
                </then>
                <else></else>
            </filter>
        </then>
        <else>
            <property name="fault" value="error when consulting userdata by id " />
            <sequence key="FaultSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="EntityUserDataIdentityUpdateSeq" value="Fin..." />
    </log>
</sequence>