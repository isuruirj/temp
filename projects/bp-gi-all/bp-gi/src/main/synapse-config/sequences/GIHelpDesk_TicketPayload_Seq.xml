<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GIHelpDesk_TicketPayload_Seq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log description="seq" level="custom">
        <property name="seq" value="-------------------- GIHelpDesk_TicketPayload_Seq --------------------"/>
        <property expression="get-property('cgi-error-codigo')" name="cgi-error-codigo"/>
        <property expression="get-property('cgi-error-mensaje')" name="cgi-error-mensaje"/>
        <property expression="get-property('scimResponse')" name="scimResponse"/>
    </log>
    <enrich description="Restore payload from MENSAJE_PETICION_VALORES">
        <source clone="true" property="MENSAJE_PETICION_VALORES" type="property"/>
        <target type="body"/>
    </enrich>
    <switch source="get-property('SOAP_ACTION_REQUEST')">
        <case regex=".*crearUsuario.*">
            <property description="accion" name="accion" scope="default" type="STRING" value="Creacion"/>
        </case>
        <case regex=".*modificarUsuario.*">
            <property description="accion" name="accion" scope="default" type="STRING" value="Modificacion"/>
        </case>
        <case regex=".*eliminarUsuario.*">
            <property description="accion" name="accion" scope="default" type="STRING" value="Eliminacion"/>
        </case>
        <default>
            <property description="accion" name="accion" scope="default" type="STRING" value="No definido"/>
        </default>
    </switch>
    <payloadFactory description="Description" media-type="xml">
        <format>
            <Description><![CDATA[
Accion: $1
Usuario: $2
Nombre Completo: $3
Identificacion: $4
Compania: $5
Division: $6
Area:$7
Departamento: $8
Cargo: $9
Aplicacion: $10
Centro de Costos: $11
Perfil: $12
Ambiente: $13
ERROR: $14 
]]></Description>
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('accion')"/>
            <arg evaluator="xml" expression="$body//*/tem:tellerName/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="fn:concat($body//*/tem:apellidosEmpleado/text(),' ', $body//*/tem:nombresEmpleado/text())" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:identificacion/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:nombreCompania/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:nombreDivision/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:nombreArea/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:nombreDepartamento/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:cargo/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="fn:upper-case(get-property('aplicacion'))"/>
            <arg evaluator="xml" expression="$body//*/tem:codigoCentroCosto/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="$body//*/tem:nombrePerfil/text()" xmlns:tem="http://tempuri.org/"/>
            <arg value="Producion"/>
            <arg evaluator="xml" expression="$ctx:scimResponse"/>
        </args>
    </payloadFactory>
    <property description="description" expression="$body//*" name="description" scope="default" type="STRING"/>
    <enrich description="Restore payload from MENSAJE_PETICION_VALORES">
        <source clone="true" property="MENSAJE_PETICION_VALORES" type="property"/>
        <target type="body"/>
    </enrich>
    <payloadFactory description="Incident Request Payload" media-type="xml">
        <format>
            <ns:CreateIM_IncidentRequest ignoreEmptyElements="true" updateconstraint="-1" xmlns:ns="http://schemas.hp.com/SM/7">
                <ns:model>
                    <ns:keys>
                        <ns:IncidentID type="String"/>
                    </ns:keys>
                    <ns:instance>
                        <ns:Category type="String">$1</ns:Category>
                        <ns:Urgency type="String">$2</ns:Urgency>
                        <ns:AssignmentGroup type="String">$3</ns:AssignmentGroup>
                        <ns:Description type="Array">
                            <ns:Description type="String"><![CDATA[$4]]></ns:Description>
                        </ns:Description>
                        <ns:Contact type="String">$5</ns:Contact>
                        <ns:Title type="String">$6</ns:Title>
                        <ns:Status type="String">$7</ns:Status>
                        <ns:Phase type="String">$8</ns:Phase>
                        <ns:Area type="String">$9</ns:Area>
                        <ns:SLAAgreementID type="Decimal">$10</ns:SLAAgreementID>
                        <ns:Subarea type="String">$11</ns:Subarea>
                        <ns:Impact type="String">$12</ns:Impact>
                        <ns:Service type="String">$13</ns:Service>
                        <ns:Filial type="String">$14</ns:Filial>
                        <ns:Ambiente type="String">$15</ns:Ambiente>
                        <ns:Assignee type="String">$16</ns:Assignee>
                    </ns:instance>
                </ns:model>
            </ns:CreateIM_IncidentRequest>
        </format>
        <args>
            <arg value="Incident"/>
            <arg value="3"/>
            <arg value="TEC_N2_ADMINISTRACION CLAVES"/>
            <arg evaluator="xml" expression="get-property('description')"/>
            <arg evaluator="xml" expression="$body//*/tem:tellerName/text()" xmlns:tem="http://tempuri.org/"/>
            <arg evaluator="xml" expression="fn:concat('Notificacion de error en aprovisionamiento de ', $ctx:accion,' ,en el aplicativo: ', fn:upper-case($ctx:aplicacion))" xmlns:tem="http://tempuri.org/"/>
            <arg value="Categorize"/>
            <arg value="Categorization"/>
            <arg value="Usuarios-perfiles"/>
            <arg value="177"/>
            <arg value="Usuarios y Accesos"/>
            <arg value="3"/>
            <arg value="Servicios Operaciones IT"/>
            <arg value="BANCO PICHINCHA"/>
            <arg value="PRODUCCION"/>
            <arg value="usrssi"/>
        </args>
    </payloadFactory>
    <enrich description="Store #incident_request">
        <source clone="true" type="body"/>
        <target property="incident_request" type="property"/>
    </enrich>
</sequence>
