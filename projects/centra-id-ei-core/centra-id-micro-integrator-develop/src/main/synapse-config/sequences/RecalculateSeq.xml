<?xml version="1.0" encoding="UTF-8"?>
<sequence name="RecalculateSeq" onError="FaultSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom" category="DEBUG">
        <property name="RecalculateSeq" value="Inicio.." />
        <property name="X-Forwarded-For" expression="$ctx:X-Forwarded-For" />
        <property name="UserName" expression="$ctx:UserName" />
        <property name="profilesSynchronizationId" expression="$ctx:profilesSynchronizationId" />
    </log>
    <property name="uri.var.transactionalIdentityId" expression="//transactionalIdentity/id" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/provisioning/TransactionalIdentity/{uri.var.transactionalIdentityId}" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <property name="typeAction" expression="//transactionalIdentity/typeAction" />
            <property name="modifyData" expression="//transactionalIdentity/modifyData" />
            <property name="profileRecalculation" expression="//transactionalIdentity/profileRecalculation" />
            <property name="transactionalIdentity" expression="$body//*" scope="default" type="OM" />
            <log level="custom" category="DEBUG">
                <property name="RecalculateSeq" value="Inicio.2." />
                <property name="uri.var.transactionalIdentityId" expression="$ctx:uri.var.transactionalIdentityId" />
                <property name="typeAction" expression="$ctx:typeAction" />
                <property name="modifyData" expression="$ctx:modifyData" />
                <property name="profileRecalculation" expression="$ctx:profileRecalculation" />
            </log>
            <call-template target="GetCurrentDateTemplate" />
            <payloadFactory media-type="json">
                <format>
                    {
                        "operationProvisioning": {
                            "transactionalIdentity": {
                                "id": $1
                            },
                            "globalProfile" :{
                                "id": $2
                            },
                            "userData" :{
                                "id": $3
                            },
                            "createdDate" : "$4",
                            "profileStartDate" : "$5",
                            "profileEndDate": null,
                            "startDate": "$6",
                            "endDate":null,
                            "modifyData": "$7",
                            "profileRecalculation": "$8",
                            "status": "REGISTRADO"
                        }
                    }                    
                </format>
                <args>
                    <arg evaluator="xml" expression="//id" />
                    <arg evaluator="xml" expression="//globalProfileId" />
                    <arg evaluator="xml" expression="//userDataId" />
                    <arg evaluator="xml" expression="get-property('currentDate')" />
                    <arg evaluator="xml" expression="get-property('currentDate')" />
                    <arg evaluator="xml" expression="get-property('currentDate')" />
                    <arg evaluator="xml" expression="//modifyData" />
                    <arg evaluator="xml" expression="//profileRecalculation" />
                </args>
            </payloadFactory>
            <call>
                <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/provisioning/OperationProvisioning" />
            </call>
            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <property name="uri.var.globalProfileId" expression="get-property('transactionalIdentity')//globalProfileId/text()" />
                    <property name="uri.var.globalProfilePreviusId" expression="get-property('transactionalIdentity')//globalProfilePreviusId/text()" />
                    <property name="uri.var.operationProvisioningId" expression="//id" />
                    <switch source="get-property('typeAction')">
                        <case regex="C">
                            <sequence key="RecalculateCreateSeq" />
                        </case>
                        <case regex="U">
                            <sequence key="RecalculateUpdateSeq" />
                        </case>
                        <case regex="D">
                            <sequence key="RecalculateDeleteSeq" />
                        </case>
                        <case regex="S">
                            <sequence key="RecalculateSynchronizationSeq" />
                        </case>
                    </switch>
                </then>
                <else>
                    <property name="fault" value="RecalculateSeq: error when create OperationProvisioning" />
                    <sequence key="FaultUserDataSeq" />
                </else>
            </filter>
        </then>
        <else>
            <property name="fault" value="RecalculateSeq: error when consulting transactionalIdentity by id" />
            <sequence key="FaultUserDataSeq" />
        </else>
    </filter>
    <log level="custom" category="DEBUG">
        <property name="RecalculateSeq" value="Fin.." />
        <property name="X-Forwarded-For" expression="$ctx:X-Forwarded-For" />
        <property name="UserName" expression="$ctx:UserName" />
    </log>
</sequence>