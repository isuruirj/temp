<?xml version="1.0" encoding="UTF-8"?>
<sequence name="MassiveProcessUsersIdentityDeleteSeq" onError="FaultMassiveProcessUsersSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse" xmlns:cen="centra-id.com">
    <log level="custom" separator="| ">
        <property name="MassiveProcessUsersIdentityDeleteSeq" value="Inicio..." />
    </log>
    <!--Salvar los datos del empleado a crear -->
    <property expression="$body//*" name="employeeData" scope="default" type="OM" />
    <log level="custom" separator="| ">
        <property name="MassiveProcessUsersIdentityDeleteSeq" expression="get-property('employeeData')//cen:username/text()" />
    </log>
    <property name="uri.var.username" expression="get-property('employeeData')//cen:username/text()" />
    <call>
        <endpoint template="HTTPEndpointGetTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/identity/UserData?username={uri.var.username}" />
    </call>
    <property name="userDataId" expression="//userData/id" />
    <!-- Eliminar UserData -->
    <payloadFactory media-type="xml">
        <format>
            <p:deleteOperation_userDataSimple xmlns:p="centra-id.com">
                <p:id>$1</p:id>
                <p:table>$2</p:table>
                <p:set>$3</p:set>
            </p:deleteOperation_userDataSimple>
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('userDataId')" />
            <arg evaluator="xml" value="sch_centra_id.USERDATA" />
            <arg evaluator="xml" value="valid=0" />
        </args>
    </payloadFactory>
    <call>
        <endpoint template="HTTPEndpointDeleteTemplate" uri="{uri.var.dataServiceHost}/identity.user-data-simple.ds.HTTPEndpoint/DeleteUserDataSimple" />
    </call>
    <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
        <then>
            <!-- Eliminar Usuario -->
            <payloadFactory media-type="xml">
                <format>
                    <xsd:deleteUser xmlns:xsd="http://org.apache.axis2/xsd" xmlns:xsd1="http://common.mgt.user.carbon.wso2.org/xsd">
                        <xsd:userName>$1</xsd:userName>
                    </xsd:deleteUser>
                </format>
                <args>
                    <arg evaluator="xml" expression="get-property('employeeData')//cen:username/text()" />
                </args>
            </payloadFactory>
            <property action="remove" name="REST_URL_POSTFIX" scope="axis2" />
            <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="IS_SERVER_USER_DATO" expression="synapse:get-property('IS_SERVER_USER')" scope="default" />
            <property xmlns:ns2="http://org.apache.synapse/xsd" xmlns:ns="http://org.apache.synapse/xsd" name="IS_SERVER_PASSWORD_DATO" expression="synapse:get-property('IS_SERVER_PASSWORD')" scope="default" />
            <property xmlns:ns="http://org.apache.synapse/xsd" name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:IS_SERVER_USER_DATO,':',$ctx:IS_SERVER_PASSWORD_DATO)))" scope="transport" />
            <call>
                <endpoint key="IS.UserAdmin" />
            </call>
            <property name="fault" expression="//UserAdminException/ax2764:message" xmlns:ns="http://org.apache.axis2/xsd" xmlns:ax2764="http://common.mgt.user.carbon.wso2.org/xsd" />
            <filter regex="true" source="boolean(get-property('fault'))">
                <then>
                    <property name="observations" expression="get-property('fault')" />
                    <sequence key="FaultMassiveProcessUsersSeq" />
                </then>
            </filter>
        </then>
        <else>
            <property name="observations" value="Error delete userdata" />
            <sequence key="FaultMassiveProcessUsersSeq" />
        </else>
    </filter>
    <log level="custom" separator="| ">
        <property name="MassiveProcessUsersIdentityDeleteSeq" value="Fin..." />
    </log>
</sequence>