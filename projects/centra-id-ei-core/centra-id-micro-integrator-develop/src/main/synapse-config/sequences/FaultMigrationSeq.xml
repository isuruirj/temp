<?xml version="1.0" encoding="UTF-8"?>
<sequence name="FaultMigrationSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <!--log level="custom" separator="| ">
        <property name="error" expression="$ctx:error" />
        <property expression="$ctx:ERROR_MESSAGE" name="message" />
        <property expression="$ctx:ERROR_CODE" name="code" />
        <property expression="$ctx:ERROR_DETAIL" name="detail" />
        <property expression="$ctx:ERROR_EXCEPTION" name="exception" />
    </log-->
    <call-template target="GetCurrentDateTemplate" />
    <filter regex="true" source="boolean($ctx:errorMigration)">
        <then>
            <payloadFactory media-type="json">
                <format>
                    {
                        "userMigrationError": {
                            "username": "$1",
                            "error": "$2",
                            "createdDate": "$3"
                        }
                    }
                </format>
                <args>
                    <arg evaluator="xml" expression="fn:concat($ctx:identi,'-',$ctx:username)" />
                    <arg evaluator="xml" expression="$ctx:errorMigration" />
                    <arg evaluator="xml" expression="$ctx:currentDate" />
                </args>
            </payloadFactory>
        </then>
        <else>
            <payloadFactory media-type="json">
                <format>
                    {
                        "userMigrationError": {
                            "username": "$1",
                            "error": "$2",
                            "createdDate": "$3"
                        }
                    }
                </format>
                <args>
                    <arg evaluator="xml" expression="fn:concat($ctx:identi,'-',$ctx:username)" />
                    <arg evaluator="xml" expression="fn:concat($ctx:ERROR_CODE,';',$ctx:ERROR_MESSAGE,';',$ctx:ERROR_DETAIL,';',$ctx:ERROR_EXCEPTION)" />
                    <arg evaluator="xml" expression="$ctx:currentDate" />
                </args>
            </payloadFactory>
        </else>
    </filter>
    <call>
        <endpoint template="HTTPEndpointPostTemplate" uri="{uri.var.enterpriseIntegratorHost}/api.centraid/common/UserMigrationError" />
    </call>
</sequence>